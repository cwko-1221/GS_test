<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸¸è­˜æˆ°å ´ - åŒæ­¥å•ç­”ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2c3e50; font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        /* ç™»å…¥ä»‹é¢ */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 1); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .avatar-selector { display: flex; gap: 15px; margin: 20px; }
        .avatar-option { font-size: 3rem; cursor: pointer; border: 3px solid transparent; border-radius: 50%; padding: 5px; transition: 0.2s; }
        .avatar-option.selected { border-color: #f1c40f; background: rgba(255,255,255,0.2); transform: scale(1.1); }
        input, button.start-btn { padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; margin-top: 10px; }
        button.start-btn { background-color: #e74c3c; color: white; cursor: pointer; font-weight: bold; }

        /* éŠæˆ²ç•«å¸ƒ */
        canvas { display: block; background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%); background-size: 40px 40px; background-color: #2c3e50; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; pointer-events: auto; }

        /* æ”»æ“ŠæŒ‰éˆ• (å¸¶å†·å»/å½ˆè—¥æ¨£å¼) */
        #attack-btn-container { position: absolute; bottom: 60px; right: 60px; pointer-events: auto; text-align: center; }
        #attack-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #7f8c8d;
            background-color: #34495e; color: #7f8c8d; font-size: 2rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; 
            transition: 0.3s;
        }
        /* æœ‰å½ˆè—¥æ™‚çš„æ¨£å¼ */
        #attack-btn.ready { background-color: #e74c3c; border-color: white; color: white; cursor: pointer; animation: pulse 2s infinite; }
        #ammo-indicator { color: white; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 0 #000; font-size: 1rem; }

        /* å€’æ•¸è¨ˆæ™‚å™¨ */
        #timer-display {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: #f1c40f; padding: 10px 20px;
            border-radius: 20px; font-size: 1.5rem; font-weight: bold; border: 2px solid #f1c40f;
        }

        /* é¡Œç›®å¼·åˆ¶å½ˆçª— */
        #quiz-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; pointer-events: auto;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .quiz-box { background: white; padding: 25px; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; border: 5px solid #3498db; }
        .quiz-timer { color: #e74c3c; font-weight: bold; margin-bottom: 10px; }
        .option-btn { display: block; width: 100%; padding: 12px; margin: 10px 0; background: #2980b9; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .option-btn:active { background: #1c5980; }

        /* æ“Šæ®º/å—å‚·é€šçŸ¥ */
        #notification { position: absolute; top: 80px; width: 100%; text-align: center; color: #e74c3c; font-weight: bold; font-size: 1.2rem; text-shadow: 1px 1px 0 white; opacity: 0; transition: opacity 0.5s; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>å¸¸è­˜å¤§äº‚é¬¥ v2</h1>
        <p>é¸æ“‡è§’è‰²ï¼š</p>
        <div class="avatar-selector">
            <div class="avatar-option selected" onclick="selectAvatar('ğŸ¯')">ğŸ¯</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ¼')">ğŸ¼</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ¦')">ğŸ¦</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ·')">ğŸ·</div>
        </div>
        <input type="text" id="username" placeholder="è¼¸å…¥åå­—" maxlength="8">
        <button class="start-btn" onclick="startGame()">åŠ å…¥éŠæˆ²</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="timer-display">ä¸‹é¡Œ: 20s</div>
        <div id="notification"></div>
        
        <div id="joystick-zone"></div>
        
        <div id="attack-btn-container">
            <div id="ammo-indicator">å½ˆè—¥: 0</div>
            <div id="attack-btn" onmousedown="handleAttack()" ontouchstart="handleAttack()">âš”ï¸</div>
        </div>
    </div>

    <div id="quiz-overlay">
        <div class="quiz-box">
            <div class="quiz-timer">âš ï¸ çªç™¼æ¸¬è©¦ âš ï¸</div>
            <h2 id="q-text">é¡Œç›®...</h2>
            <div id="q-options"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: è€å¸«è«‹åœ¨æ­¤æ›¿æ› Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
  authDomain: "gsmoney-65f2f.firebaseapp.com",
  projectId: "gsmoney-65f2f",
  storageBucket: "gsmoney-65f2f.firebasestorage.app",
  messagingSenderId: "176138167950",
  appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
  measurementId: "G-BKB004KPBN"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const GAME_ID = "arena_v2"; // æ–°çš„æˆ¿é–“ ID

    // --- å…¨å±€è®Šæ•¸ ---
    let myId = "p_" + Math.random().toString(36).substr(2, 6);
    let myName = "";
    let myAvatar = "ğŸ¯";
    let myPos = { x: 200, y: 200, angle: 0 };
    let myHp = 100;
    let bullets = [];
    let players = {}; 
    let ammo = 0;
    let isQuizActive = false;
    let nextQuizTime = 0; // ä¸‹æ¬¡å•ç­”çš„ç›®æ¨™æ™‚é–“æˆ³

    // Canvas
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- é¡Œç›®è¨­å®š (è€å¸«å¯æ“´å……) ---
    const questionBank = [
        { q: "è¡Œäººç´…ç‡ˆäº®èµ·æ™‚ï¼Œæˆ‘å€‘æ‡‰è©²ï¼Ÿ", opt: ["è¡éå»", "åœä¸‹ç­‰å¾…", "æ…¢æ…¢èµ°"], ans: 1 },
        { q: "ä¸€å¤©æœ‰å¤šå°‘å€‹å°æ™‚ï¼Ÿ", opt: ["12", "24", "48"], ans: 1 },
        { q: "å“ªç¨®å‹•ç‰©æ˜¯å“ºä¹³é¡ï¼Ÿ", opt: ["é¯¨é­š", "é±·é­š", "é‡‘é­š"], ans: 0 },
        { q: "ç«è­¦ç™¼ç”Ÿæ™‚è¦æ‰“é›»è©±è™Ÿç¢¼ï¼Ÿ", opt: ["992", "999", "911"], ans: 1 },
        { q: "ä¿æŒç‰™é½’å¥åº·è¦ï¼Ÿ", opt: ["å¤šåƒç³–", "æ—©æ™šåˆ·ç‰™", "ç”¨ç‰™å’¬æ ¸æ¡ƒ"], ans: 1 }
    ];

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    window.selectAvatar = (char) => {
        myAvatar = char;
        document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
        event.target.classList.add('selected');
    };

    // --- æ ¸å¿ƒæµç¨‹ ---

    window.startGame = async () => {
        const nameInput = document.getElementById('username').value;
        if (!nameInput) return alert("è«‹è¼¸å…¥åå­—");
        myName = nameInput;

        document.getElementById('login-screen').style.display = 'none';
        
        initJoystick();

        // å¯«å…¥åˆå§‹è³‡æ–™
        await updateMyStatus(true);
        
        // ç›£è½å…¶ä»–ç©å®¶
        listenToPlayers();

        // å•Ÿå‹•è¿´åœˆ
        requestAnimationFrame(gameLoop);
        setInterval(uploadPosition, 150); // æ¯0.15ç§’ä¸Šå‚³ä¸€æ¬¡ä½ç½®
        setInterval(checkGlobalTimer, 1000); // æ¯ç§’æª¢æŸ¥æ™‚é–“æ˜¯å¦è©²è§¸ç™¼é¡Œç›®

        // é›¢ç·šè™•ç†ï¼šé—œé–‰è¦–çª—æ™‚åˆªé™¤è‡ªå·±
        window.addEventListener('beforeunload', () => {
            deleteDoc(doc(db, 'games', GAME_ID, 'players', myId));
        });
    };

    // æ›´æ–°è‡ªå·±çš„è³‡æ–™åˆ°è³‡æ–™åº«
    async function updateMyStatus(forceFullUpdate = false) {
        const ref = doc(db, 'games', GAME_ID, 'players', myId);
        const data = {
            x: Math.round(myPos.x),
            y: Math.round(myPos.y),
            angle: parseFloat(myPos.angle.toFixed(2)),
            hp: myHp,
            lastSeen: serverTimestamp() // é—œéµï¼šå¿ƒè·³åŒ…
        };
        if (forceFullUpdate) {
            data.name = myName;
            data.avatar = myAvatar;
        }
        await setDoc(ref, data, { merge: true });
    }
    
    // å®šæ™‚ä¸Šå‚³ä½ç½® (è¢«å‹•å¿ƒè·³)
    function uploadPosition() {
        if(myHp > 0) updateMyStatus();
    }

    // --- æ–æ¡¿èˆ‡ç§»å‹• ---
    let moveData = { speed: 0, angle: 0, active: false };
    function initJoystick() {
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-zone'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'white',
            size: 100
        });
        joystick.on('move', (evt, data) => {
            moveData.active = true;
            moveData.angle = data.angle.radian;
            moveData.speed = Math.min(data.distance, 50) / 8;
            myPos.angle = moveData.angle; 
        });
        joystick.on('end', () => moveData.active = false);
    }

    // --- å…¨çƒåŒæ­¥ç­”é¡Œé‚è¼¯ ---
    function checkGlobalTimer() {
        const now = new Date();
        const seconds = now.getSeconds();
        const mod = seconds % 20; // 0, 20, 40
        const timeLeft = 20 - mod;

        document.getElementById('timer-display').innerText = `ä¸‹é¡Œ: ${timeLeft}s`;

        // å¦‚æœå‰›å¥½æ˜¯ 0, 20, 40 ç§’ï¼Œä¸”ç›®å‰æ²’æœ‰é–‹é¡Œç›®
        if (mod === 0 && !isQuizActive) {
            triggerQuiz();
        }
    }

    function triggerQuiz() {
        isQuizActive = true;
        moveData.active = false; // å¼·åˆ¶åœæ­¢ç§»å‹•
        
        const overlay = document.getElementById('quiz-overlay');
        const qText = document.getElementById('q-text');
        const qOptions = document.getElementById('q-options');
        
        // éš¨æ©Ÿé¸é¡Œ
        const q = questionBank[Math.floor(Math.random() * questionBank.length)];
        qText.innerText = q.q;
        qOptions.innerHTML = '';
        
        q.opt.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if (idx === q.ans) {
                    // ç­”å°çå‹µ
                    ammo += 3; // è£œçµ¦3ç™¼
                    myHp = Math.min(100, myHp + 10); // é †ä¾¿å›è¡€
                    showNotification("ç­”å°äº†ï¼å½ˆè—¥å¡«å……ï¼");
                } else {
                    showNotification("ç­”éŒ¯äº†...éŒ¯å¤±æ©Ÿæœƒ");
                }
                updateAmmoUI();
                overlay.style.display = 'none';
                isQuizActive = false;
            };
            qOptions.appendChild(btn);
        });
        
        overlay.style.display = 'flex';
    }

    // --- æ”»æ“Šç³»çµ± ---
    window.handleAttack = () => {
        if (ammo > 0 && myHp > 0 && !isQuizActive) {
            fireBullet();
        } else if (ammo <= 0) {
            showNotification("æ²’æœ‰å½ˆè—¥ï¼ç­‰å¾…é¡Œç›®å‡ºç¾ï¼");
        }
    };

    function updateAmmoUI() {
        const btn = document.getElementById('attack-btn');
        const indicator = document.getElementById('ammo-indicator');
        indicator.innerText = `å½ˆè—¥: ${ammo}`;
        if (ammo > 0) {
            btn.classList.add('ready');
        } else {
            btn.classList.remove('ready');
        }
    }

    function showNotification(msg) {
        const noti = document.getElementById('notification');
        noti.innerText = msg;
        noti.style.opacity = 1;
        setTimeout(() => noti.style.opacity = 0, 2000);
    }

    function fireBullet() {
        ammo--;
        updateAmmoUI();
        
        const bullet = {
            id: myId + "_" + Date.now(),
            owner: myId,
            x: myPos.x,
            y: myPos.y,
            vx: Math.cos(myPos.angle) * 10,
            vy: Math.sin(myPos.angle) * 10 * -1,
            life: 50
        };
        bullets.push(bullet);
    }

    // --- Firebase ç›£è½ ---
    function listenToPlayers() {
        const playersRef = collection(db, 'games', GAME_ID, 'players');
        onSnapshot(playersRef, (snapshot) => {
            snapshot.forEach(doc => {
                const data = doc.data();
                if (doc.id === myId) {
                    // å¦‚æœæˆ‘åœ¨ Server ç«¯å·²ç¶“æ²’è¡€äº† (è¢«åˆ¥äººæ‰“äº†)
                    if (data.hp < myHp) {
                        showNotification(`å—åˆ°å‚·å®³! HP -${myHp - data.hp}`);
                    }
                    myHp = data.hp; // åŒæ­¥è¡€é‡
                    if (myHp <= 0) {
                         // æ­»äº¡è™•ç†
                         myHp = 0;
                         showNotification("ä½ å·²è¢«æ·˜æ±°...ç­‰å¾…é¡Œç›®å¾©æ´»");
                         // å¯ä»¥å¢åŠ å¾©æ´»é‚è¼¯
                    }
                } else {
                    // å„²å­˜å…¶ä»–ç©å®¶è³‡æ–™
                    players[doc.id] = data;
                }
            });
            // æ³¨æ„ï¼šæˆ‘å€‘åœ¨é€™è£¡ä¸åˆªé™¤ players ç‰©ä»¶è£¡çš„èˆŠ keyï¼Œè€Œæ˜¯åœ¨ draw è¿´åœˆè£¡éæ¿¾
        });
    }

    // --- éŠæˆ²è¿´åœˆ ---
    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ç§»å‹•è‡ªå·± (å¦‚æœæ´»è‘—ä¸”æ²’åœ¨ç­”é¡Œ)
        if (moveData.active && myHp > 0 && !isQuizActive) {
            myPos.x += Math.cos(moveData.angle) * moveData.speed;
            myPos.y -= Math.sin(moveData.angle) * moveData.speed;
            // é‚Šç•Œ
            myPos.x = Math.max(30, Math.min(canvas.width-30, myPos.x));
            myPos.y = Math.max(30, Math.min(canvas.height-30, myPos.y));
        }

        // 2. ç¹ªè£½è‡ªå·±
        if (myHp > 0) {
            drawPlayer(myPos.x, myPos.y, myAvatar, myName, true, myPos.angle, myHp);
        } else {
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "white";
            ctx.font = "30px Arial";
            ctx.textAlign = "center";
            ctx.fillText("ä½ å·²é™£äº¡ï¼Œç­‰å¾…ä¸‹ä¸€é¡Œå¾©æ´»...", canvas.width/2, canvas.height/2);
        }

        // 3. ç¹ªè£½å…¶ä»–ç©å®¶ (éæ¿¾æ‰æ–·ç·šè¶…é5ç§’çš„äºº)
        const now = Date.now();
        for (let pid in players) {
            const p = players[pid];
            // åˆ¤æ–·æ˜¯å¦ã€Œåœ¨ç·šã€ï¼šlastSeen å­˜åœ¨ä¸”åœ¨ 5 ç§’å…§
            let isOnline = false;
            if (p.lastSeen) {
                // Firebase timestamp è½‰æ›
                const lastSeenTime = p.lastSeen.seconds ? p.lastSeen.seconds * 1000 : p.lastSeen; 
                if (now - lastSeenTime < 5000) isOnline = true;
            }

            if (isOnline && p.hp > 0) {
                // å¹³æ»‘æ’å€¼ (è®“å‹•ä½œä¸é‚£éº¼å¡) - ç°¡æ˜“ç‰ˆç›´æ¥è³¦å€¼
                drawPlayer(p.x, p.y, p.avatar, p.name, false, p.angle, p.hp);
            }
        }

        // 4. å­å½ˆè™•ç†èˆ‡ç¢°æ’
        updateBullets();

        requestAnimationFrame(gameLoop);
    }

    function drawPlayer(x, y, avatar, name, isMe, angle, hp) {
        ctx.save();
        ctx.translate(x, y);

        // ç¹ªè£½è¡€æ¢èƒŒæ™¯ (ç°)
        ctx.fillStyle = "#555";
        ctx.fillRect(-25, -45, 50, 6);
        
        // ç¹ªè£½å‹•æ…‹è¡€æ¢ (ç¶ /ç´…) - æ ¹æ“š HP æ¯”ä¾‹
        const hpPercent = Math.max(0, hp / 100);
        ctx.fillStyle = hpPercent > 0.3 ? "#2ecc71" : "#e74c3c";
        ctx.fillRect(-25, -45, 50 * hpPercent, 6);

        // åå­—
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.fillText(name, 0, -50);

        // é ­åƒ
        ctx.font = "35px Arial";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "black";
        ctx.shadowBlur = 5;
        ctx.fillText(avatar, 0, 0);
        ctx.shadowBlur = 0;

        // æ–¹å‘æŒ‡ç¤ºå™¨
        ctx.rotate(-angle);
        ctx.beginPath();
        ctx.moveTo(25, 0);
        ctx.lineTo(35, 0);
        ctx.strokeStyle = isMe ? "#f1c40f" : "rgba(255,255,255,0.7)";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.stroke();

        ctx.restore();
    }

    function updateBullets() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.x += b.vx;
            b.y += b.vy;
            b.life--;

            ctx.beginPath();
            ctx.arc(b.x, b.y, 6, 0, Math.PI * 2);
            ctx.fillStyle = "#e67e22";
            ctx.fill();

            // ç¢°æ’åˆ¤å®š (åªç”±æ”»æ“Šç™¼èµ·æ–¹è¨ˆç®—ï¼Œæ¸›å°‘é‡è¤‡æ‰£è¡€)
            if (b.owner === myId) {
                for (let pid in players) {
                    const p = players[pid];
                    // ç¢ºä¿åªæ‰“åˆ°æ´»è‘—ä¸”åœ¨ç·šçš„äºº
                    if (p.hp > 0) {
                        const dist = Math.hypot(b.x - p.x, b.y - p.y);
                        if (dist < 35) {
                            // æ“Šä¸­ï¼
                            console.log("Hit!", p.name);
                            // ç›´æ¥æ‰£é™¤è³‡æ–™åº«è¡€é‡
                            const targetRef = doc(db, 'games', GAME_ID, 'players', pid);
                            // å®‰å…¨èµ·è¦‹ï¼Œé€™è£¡æ‡‰è©²ç”¨ transactionï¼Œä½†ç°¡æ˜“ç‰ˆç›´æ¥ update
                            updateDoc(targetRef, { hp: p.hp - 10 });
                            
                            b.life = 0; // å­å½ˆæ¶ˆå¤±
                            break;
                        }
                    }
                }
            }

            if (b.life <= 0) bullets.splice(i, 1);
        }
    }

</script>
</body>
</html>