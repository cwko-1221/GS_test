<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¿åºœç†è²¡å¤§ä½œæˆ° (é€£ç·šç‰ˆ)</title>
    
    <!-- å¼•å…¥ Firebase æ ¸å¿ƒèˆ‡è³‡æ–™åº« -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> <!-- æ–°å¢ï¼šé©—è­‰æ¨¡çµ„ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; background: #f0f0f0; user-select: none; -webkit-user-select: none; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; }
        h1 { color: #2c3e50; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        input { padding: 15px; font-size: 20px; border: 3px solid #ddd; border-radius: 12px; margin-bottom: 20px; width: 80%; max-width: 300px; text-align: center; outline: none; }
        input:focus { border-color: #2196F3; }
        .btn { padding: 15px 40px; margin: 10px; font-size: 20px; border: none; border-radius: 50px; cursor: pointer; color: white; width: 85%; max-width: 350px; box-shadow: 0 6px 0 rgba(0,0,0,0.1); font-weight: bold; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-student { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); }
        .btn-teacher { background: linear-gradient(to bottom, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #444; }
        
        #gameUI { display: none; }
        canvas { background: #eee; display: block; }
        #hud { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 5; display: flex; flex-direction: column; gap: 5px; }
        .hud-box { background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 16px; }
        
        #questionModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; background: white; border: 6px solid #FF9800; border-radius: 20px; padding: 20px; box-sizing: border-box; text-align: center; z-index: 100; box-shadow: 0 0 100px rgba(0,0,0,0.7); }
        .opt-btn { display: block; width: 100%; padding: 15px; margin: 8px 0; background: #fff; color: #333; border: 2px solid #ddd; border-radius: 10px; font-size: 18px; cursor: pointer; font-weight: bold; }
        
        /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; 
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; 
            font-size: 12px; overflow-y: scroll; padding: 10px; box-sizing: border-box;
            z-index: 9999; display: block; pointer-events: none;
        }
        .log-error { color: #ff5252; font-weight: bold; }
        .log-warn { color: #ffeb3b; }
        .log-success { color: #69f0ae; }
    </style>
</head>
<body>

    <!-- é™¤éŒ¯è¦–çª— (æœƒé¡¯ç¤ºæ‰€æœ‰éŒ¯èª¤) -->
    <div id="debug-console">ç³»çµ±å•Ÿå‹•ä¸­...</div>

    <!-- 1. ä¸»é¸å–® -->
    <div id="menuScreen" class="screen">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸŒ</div>
        <h1>æ”¿åºœç†è²¡å¤§ä½œæˆ°</h1>
        <h2>é€£ç·šä¿®æ­£ç‰ˆ</h2>
        
        <input type="text" id="playerName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿåå­—" maxlength="8">
        
        <button class="btn btn-student" id="btnJoin" onclick="joinGame()">æˆ‘æ˜¯å­¸ç”Ÿ (åŠ å…¥éŠæˆ²)</button>
        <button class="btn btn-teacher" onclick="startTeacherMode()">æˆ‘æ˜¯è€å¸« (ä¸»æŒéŠæˆ²)</button>
        
        <p style="font-size: 12px; color: #666; margin-top: 10px;">ç‹€æ…‹: <span id="connectionStatus">æª¢æŸ¥ä¸­...</span></p>
    </div>

    <!-- 2. è€å¸«ç•«é¢ -->
    <div id="teacherScreen" class="screen hidden">
        <h2>ğŸ“± æƒæåŠ å…¥éŠæˆ²</h2>
        <div id="qrcode" style="background:white; padding:10px; border-radius:10px;"></div>
        <div style="margin-top:10px; font-family:monospace; background:white; padding:5px;"><span id="urlText"></span></div>
        <h3>ğŸ† æ’è¡Œæ¦œ (<span id="playerCount">0</span>äºº)</h3>
        <div id="leaderboard" style="width:90%; height:300px; overflow-y:auto; background:rgba(255,255,255,0.8); padding:10px; border-radius:10px;">ç­‰å¾…å­¸ç”ŸåŠ å…¥...</div>
        <button class="btn btn-teacher" style="background:#ff5252; color:white; font-size:16px; padding:10px;" onclick="resetServer()">é‡ç½®éŠæˆ²</button>
        <button class="btn btn-teacher" style="background:#999; color:white; font-size:16px; padding:10px;" onclick="location.reload()">è¿”å›</button>
    </div>

    <!-- 3. éŠæˆ²ç•«é¢ -->
    <div id="gameUI">
        <canvas id="canvas"></canvas>
        <div id="hud">
            <div class="hud-box">ğŸ‘¤ <span id="hudName">Player</span></div>
            <div class="hud-box">ğŸ“Š åˆ†æ•¸: <span id="hudScore">0</span></div>
        </div>
        <div id="questionModal">
            <h2 id="qTitle">é¡Œç›®</h2>
            <div id="qOptions"></div>
        </div>
    </div>

    <script>
        // =========================================================
        // ğŸ”´ğŸ”´ğŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ FIREBASE CONFIG ğŸ”´ğŸ”´ğŸ”´
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
            authDomain: "gsmoney-65f2f.firebaseapp.com",
            databaseURL: "https://gsmoney-65f2f-default-rtdb.firebaseio.com",
            projectId: "gsmoney-65f2f",
            storageBucket: "gsmoney-65f2f.firebasestorage.app",
            messagingSenderId: "176138167950",
            appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
            measurementId: "G-BKB004KPBN"
        };
        // =========================================================

        // --- é™¤éŒ¯æ—¥èªŒå·¥å…· ---
        function log(msg, type = 'info') {
            const consoleDiv = document.getElementById('debug-console');
            const p = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            p.innerText = `[${time}] ${msg}`;
            if(type === 'error') p.className = 'log-error';
            if(type === 'success') p.className = 'log-success';
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`ç³»çµ±éŒ¯èª¤: ${message}`, 'error');
        };

        // --- åˆå§‹åŒ–æª¢æŸ¥ ---
        let db, playersRef, gameRef, auth;
        let isConfigured = false;

        function initApp() {
            if (!firebaseConfig.apiKey) {
                log("âŒ éŒ¯èª¤: firebaseConfig æœªè¨­å®šï¼è«‹ç·¨è¼¯ç¨‹å¼ç¢¼ã€‚", 'error');
                alert("è«‹æ³¨æ„ï¼šä½ é‚„æ²’æœ‰è¨­å®š Firebase Configï¼\nè«‹æ‰“é–‹ç¨‹å¼ç¢¼ï¼Œåœ¨ç¬¬ 110 è¡Œå·¦å³å¡«å…¥ä½ çš„è³‡æ–™åº«è¨­å®šã€‚");
                document.getElementById('connectionStatus').innerText = "âŒ Config æœªè¨­å®š";
                document.getElementById('connectionStatus').style.color = "red";
                return;
            }

            if (!firebaseConfig.databaseURL) {
                log("âŒ éŒ¯èª¤: firebaseConfig ç¼ºå°‘ databaseURLï¼", 'error');
                alert("Config éŒ¯èª¤ï¼šç¼ºå°‘ databaseURLã€‚\nè«‹ç¢ºèªä½ çš„ Config åŒ…å« databaseURL: 'https://...'");
                return;
            }

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.database();
                playersRef = db.ref('players');
                gameRef = db.ref('gameState');
                isConfigured = true;
                log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ", 'success');

                // å˜—è©¦åŒ¿åç™»å…¥ (è§£æ±ºæ¬Šé™å•é¡Œçš„é—œéµ)
                log("æ­£åœ¨å˜—è©¦åŒ¿åç™»å…¥...");
                auth.signInAnonymously()
                    .then((userCredential) => {
                        log(`âœ… ç™»å…¥æˆåŠŸ! UID: ${userCredential.user.uid}`, 'success');
                        document.getElementById('connectionStatus').innerText = "âœ… å·²é€£ç·š";
                        document.getElementById('connectionStatus').style.color = "green";
                    })
                    .catch((error) => {
                        log(`âŒ ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
                        document.getElementById('connectionStatus').innerText = "âš ï¸ é©—è­‰å¤±æ•— (è«‹æª¢æŸ¥ Console)";
                    });

            } catch (e) {
                log(`âŒ åˆå§‹åŒ–å´©æ½°: ${e.message}`, 'error');
                alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
            }
        }

        // ç«‹å³åŸ·è¡Œåˆå§‹åŒ–
        setTimeout(initApp, 500);

        // --- éŠæˆ²é‚è¼¯è®Šæ•¸ ---
        const questions = [
            { q: "æ”¿åºœç†è²¡çš„é¦–è¦åŸå‰‡æ˜¯ä»€éº¼ï¼Ÿ", opts: ["é‡å…¥ç‚ºå‡º", "å…ˆä½¿æœªä¾†éŒ¢", "éš¨æ„æ¶ˆè²»"], ans: 0 },
            { q: "æ‰“å·¥ä»”æ¯æœˆæœ‰è–ªé‡‘ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["åˆ©å¾—ç¨…", "è–ªä¿¸ç¨…", "å°èŠ±ç¨…"], ans: 1 },
            { q: "å…¬å¸è³ºå–åˆ©æ½¤å¾Œï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["è–ªä¿¸ç¨…", "å°èŠ±ç¨…", "åˆ©å¾—ç¨…"], ans: 2 },
            { q: "è²·è³£æ¨“å®‡ä½å®…æ™‚ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["å°èŠ±ç¨…", "åœ°åƒ¹ç¨…", "å¢å€¼ç¨…"], ans: 0 },
            { q: "ã€Œç›ˆé¤˜ã€æœƒæ’¥å…¥å“ªè£¡ï¼Ÿ", opts: ["è²¡æ”¿å„²å‚™", "éŠ€è¡Œ", "å®˜å“¡å£è¢‹"], ans: 0 },
            { q: "ä»¥ä¸‹å“ªé …ä¸æ˜¯é¦™æ¸¯ä¸»è¦é–‹æ”¯ï¼Ÿ", opts: ["æ•™è‚²", "è»è²»", "é†«ç™‚"], ans: 1 },
        ];
        const WORLD_SIZE = 2500;
        let myId = null;
        let me = { x: 0, y: 0, r: 25, color: '#00f', name: '' };
        let allPlayers = {};
        let canvas, ctx, mouseX = 0, mouseY = 0, lastUploadTime = 0;

        // --- å­¸ç”ŸåŠ å…¥éŠæˆ² ---
        function joinGame() {
            if(!isConfigured) return alert("è«‹å…ˆè¨­å®š Firebase Configï¼");
            
            const name = document.getElementById('playerName').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

            const btn = document.getElementById('btnJoin');
            btn.disabled = true;
            btn.innerText = "åŠ å…¥ä¸­...";
            log(`å­¸ç”Ÿå˜—è©¦åŠ å…¥: ${name}`);

            // ç¢ºä¿å·²ç™»å…¥
            if(!auth.currentUser) {
                log("å°šæœªç™»å…¥ï¼Œé‡æ–°å˜—è©¦ç™»å…¥...", 'warn');
                auth.signInAnonymously().then(() => doJoin(name)).catch(e => {
                    btn.disabled = false;
                    btn.innerText = "æˆ‘æ˜¯å­¸ç”Ÿ (åŠ å…¥éŠæˆ²)";
                    alert("ç™»å…¥å¤±æ•—ï¼Œç„¡æ³•åŠ å…¥éŠæˆ²ã€‚\n" + e.message);
                });
            } else {
                doJoin(name);
            }
        }

        function doJoin(name) {
            me.name = name;
            me.x = Math.random() * WORLD_SIZE;
            me.y = Math.random() * WORLD_SIZE;
            me.color = `hsl(${Math.random() * 360}, 80%, 60%)`;

            // å¯«å…¥è³‡æ–™åº«
            const newRef = playersRef.push();
            myId = newRef.key;

            newRef.set(me)
                .then(() => {
                    log("âœ… æˆåŠŸå¯«å…¥è³‡æ–™åº«ï¼Œé€²å…¥éŠæˆ²", 'success');
                    startGame();
                    // æ–·ç·šæ™‚è‡ªå‹•ç§»é™¤è‡ªå·±
                    newRef.onDisconnect().remove();
                })
                .catch((error) => {
                    log(`âŒ å¯«å…¥å¤±æ•—: ${error.message}`, 'error');
                    alert("ç„¡æ³•åŠ å…¥éŠæˆ²ï¼\nå¯èƒ½åŸå› ï¼š\n1. è³‡æ–™åº« Rules æ²’é–‹ (è¨­ç‚º true)\n2. ç¶²è·¯ä¸ç©©\néŒ¯èª¤è¨Šæ¯: " + error.message);
                    document.getElementById('btnJoin').disabled = false;
                    document.getElementById('btnJoin').innerText = "æˆ‘æ˜¯å­¸ç”Ÿ (åŠ å…¥éŠæˆ²)";
                });
        }

        function startGame() {
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('hudName').innerText = me.name;
            document.getElementById('debug-console').style.display = 'none'; // éš±è—é™¤éŒ¯è¦–çª—

            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);
            
            // ç¶å®šè¼¸å…¥
            window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
            window.addEventListener('touchmove', e => { e.preventDefault(); mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; }, {passive: false});

            // ç›£è½ç©å®¶èˆ‡é¡Œç›®
            playersRef.on('value', snap => { allPlayers = snap.val() || {}; if(!allPlayers[myId] && myId) respawn(); });
            gameRef.on('value', snap => {
                const data = snap.val();
                if(data && Date.now() - data.qid < 5000) showQuestion(data.idx);
            });

            requestAnimationFrame(gameLoop);
        }

        function respawn() {
            me.x = Math.random() * WORLD_SIZE;
            me.y = Math.random() * WORLD_SIZE;
            me.r = 25;
            playersRef.child(myId).set(me);
        }

        function gameLoop() {
            if(!myId) return;
            
            // ç§»å‹•
            const dx = mouseX - canvas.width / 2;
            const dy = mouseY - canvas.height / 2;
            const angle = Math.atan2(dy, dx);
            const speed = Math.max(2, 8 - (me.r / 50));
            if(Math.hypot(dx, dy) > 10) {
                me.x += Math.cos(angle) * speed;
                me.y += Math.sin(angle) * speed;
            }
            me.x = Math.max(0, Math.min(WORLD_SIZE, me.x));
            me.y = Math.max(0, Math.min(WORLD_SIZE, me.y));

            // ä¸Šå‚³ä½ç½®
            if(Date.now() - lastUploadTime > 50) {
                playersRef.child(myId).update({ x: Math.round(me.x), y: Math.round(me.y), r: me.r });
                lastUploadTime = Date.now();
            }

            // ç¢°æ’èˆ‡ç¹ªåœ–
            checkCollisions();
            draw();
            document.getElementById('hudScore').innerText = Math.floor(me.r);
            requestAnimationFrame(gameLoop);
        }

        function checkCollisions() {
            for (let id in allPlayers) {
                if (id === myId) continue;
                const p = allPlayers[id];
                const dist = Math.hypot(me.x - p.x, me.y - p.y);
                if (dist < me.r && me.r > p.r * 1.1) {
                    me.r += p.r * 0.4;
                    playersRef.child(id).remove();
                }
            }
        }

        function showQuestion(idx) {
            const q = questions[idx];
            const modal = document.getElementById('questionModal');
            document.getElementById('qTitle').innerText = q.q;
            document.getElementById('qOptions').innerHTML = "";
            modal.style.display = 'block';

            q.opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    modal.style.display = 'none';
                    if(i === q.ans) { me.r += 15; alert("âœ… ç­”å°äº†ï¼"); }
                    else { me.r = Math.max(10, me.r - 5); alert("âŒ ç­”éŒ¯äº†..."); }
                    playersRef.child(myId).update({ r: me.r });
                };
                document.getElementById('qOptions').appendChild(btn);
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-(me.x - canvas.width/2), -(me.y - canvas.height/2));
            
            // é‚Šç•Œèˆ‡ç¶²æ ¼
            ctx.strokeStyle = "#ff0000"; ctx.lineWidth = 5; ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);
            ctx.strokeStyle = "#ddd"; ctx.lineWidth = 1; ctx.beginPath();
            for(let x=0; x<=WORLD_SIZE; x+=50) { ctx.moveTo(x,0); ctx.lineTo(x,WORLD_SIZE); }
            for(let y=0; y<=WORLD_SIZE; y+=50) { ctx.moveTo(0,y); ctx.lineTo(WORLD_SIZE,y); }
            ctx.stroke();

            for (let id in allPlayers) {
                const p = allPlayers[id];
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = p.color || "#999"; ctx.fill();
                ctx.fillStyle = "#333"; ctx.font = "14px Arial"; ctx.textAlign = "center";
                ctx.fillText(p.name, p.x, p.y - p.r - 5);
            }
            ctx.restore();
        }
        
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

        // --- è€å¸«ç«¯ ---
        function startTeacherMode() {
            if(!isConfigured) return alert("Config æœªè¨­å®šï¼");
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('teacherScreen').classList.remove('hidden');
            document.getElementById('urlText').innerText = window.location.href;
            new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 200, height: 200 });
            
            playersRef.on('value', snap => {
                const list = document.getElementById('leaderboard');
                list.innerHTML = "";
                const data = snap.val() || {};
                const sorted = Object.values(data).sort((a, b) => b.r - a.r);
                document.getElementById('playerCount').innerText = sorted.length;
                sorted.forEach((p, i) => list.innerHTML += `<div style="border-bottom:1px solid #ccc; padding:5px;">#${i+1} <b>${p.name}</b> (${Math.floor(p.r)})</div>`);
            });
            
            setInterval(() => {
                const qIdx = Math.floor(Math.random() * questions.length);
                gameRef.set({ qid: Date.now(), idx: qIdx });
            }, 15000);
        }

        function resetServer() { if(confirm("é‡ç½®éŠæˆ²ï¼Ÿ")) { playersRef.remove(); gameRef.remove(); } }
    </script>
</body>
</html>