<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸¸è­˜æˆ°å ´ - å‹•ä½œç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2c3e50; font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; touch-action: none; }
        
        /* ç™»å…¥ä»‹é¢ */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .avatar-selector { display: flex; gap: 15px; margin: 20px; }
        .avatar-option { font-size: 3rem; cursor: pointer; border: 3px solid transparent; border-radius: 50%; padding: 5px; transition: 0.2s; }
        .avatar-option.selected { border-color: #f1c40f; background: rgba(255,255,255,0.2); transform: scale(1.1); }
        input, button.start-btn { padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; margin-top: 10px; }
        button.start-btn { background-color: #e74c3c; color: white; cursor: pointer; font-weight: bold; }

        /* éŠæˆ²ç•«å¸ƒ */
        canvas { display: block; background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%); background-size: 40px 40px; background-color: #2c3e50; }

        /* UI å±¤ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* å·¦ä¸‹è§’æ–æ¡¿å€ (ç”± nipplejs ç”Ÿæˆï¼Œé€™è£¡åªéœ€å®šä½å®¹å™¨) */
        #joystick-zone { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; pointer-events: auto; }

        /* å³ä¸‹è§’æ”»æ“ŠæŒ‰éˆ• */
        #attack-btn-container { position: absolute; bottom: 60px; right: 60px; pointer-events: auto; text-align: center; }
        #attack-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid white;
            background-color: #95a5a6; color: white; font-size: 2rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; display: flex; justify-content: center; align-items: center; user-select: none;
        }
        #attack-btn.active { background-color: #e74c3c; animation: pulse 1s infinite; }
        #ammo-indicator { color: #f1c40f; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 0 #000; font-size: 1.2rem; }

        /* é¡Œç›®å½ˆçª— */
        #quiz-modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; pointer-events: auto; z-index: 50;
        }
        .option-btn { display: block; width: 100%; padding: 10px; margin: 10px 0; background: #3498db; color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; }

        /* ç‹€æ…‹æ¢ */
        #status-bar { position: absolute; top: 10px; left: 10px; color: white; font-size: 1rem; font-weight: bold; text-shadow: 1px 1px 2px black; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>å¸¸è­˜å¤§äº‚é¬¥ - å‹•ä½œç‰ˆ</h1>
        <p>é¸æ“‡ä½ çš„è§’è‰²ï¼š</p>
        <div class="avatar-selector">
            <div class="avatar-option" onclick="selectAvatar('ğŸ¯')">ğŸ¯</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ¼')">ğŸ¼</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ¦Š')">ğŸ¦Š</div>
            <div class="avatar-option" onclick="selectAvatar('ğŸ·')">ğŸ·</div>
        </div>
        <input type="text" id="username" placeholder="è¼¸å…¥åå­—" maxlength="8">
        <button class="start-btn" onclick="startGame()">é€²å…¥æˆ°å ´</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="status-bar">æº–å‚™ä¸­...</div>
        
        <div id="joystick-zone"></div>
        
        <div id="attack-btn-container">
            <div id="ammo-indicator">å½ˆè—¥: 0</div>
            <div id="attack-btn" onclick="handleAttack()">âš”ï¸</div>
        </div>

        <div id="quiz-modal">
            <h3 id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</h3>
            <div id="q-options"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: æ›¿æ›ç‚ºæ‚¨çš„ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
  authDomain: "gsmoney-65f2f.firebaseapp.com",
  projectId: "gsmoney-65f2f",
  storageBucket: "gsmoney-65f2f.firebasestorage.app",
  messagingSenderId: "176138167950",
  appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
  measurementId: "G-BKB004KPBN"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const GAME_ID = "arena_1";

    // --- éŠæˆ²å…¨å±€è®Šæ•¸ ---
    let myId = "p_" + Math.random().toString(36).substr(2, 5);
    let myName = "ç„¡åæ°";
    let myAvatar = "ğŸ¯";
    let myPos = { x: 200, y: 200, angle: 0 }; // æœ¬åœ°åº§æ¨™
    let bullets = []; // ç•«é¢ä¸Šçš„å­å½ˆ
    let players = {}; // å…¶ä»–ç©å®¶è³‡æ–™
    let ammo = 0;
    
    // Canvas è¨­å®š
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let mapWidth = window.innerWidth;
    let mapHeight = window.innerHeight;

    // èª¿æ•´ç•«å¸ƒå¤§å°
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        mapWidth = canvas.width;
        mapHeight = canvas.height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- è§’è‰²é¸æ“‡é‚è¼¯ ---
    window.selectAvatar = (char) => {
        myAvatar = char;
        document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
    };

    // --- é–‹å§‹éŠæˆ²é‚è¼¯ ---
    window.startGame = async () => {
        const nameInput = document.getElementById('username').value;
        if (!nameInput) return alert("è«‹è¼¸å…¥åå­—");
        myName = nameInput;

        document.getElementById('login-screen').style.display = 'none';
        
        // 1. åˆå§‹åŒ–æ–æ¡¿
        initJoystick();

        // 2. å¯«å…¥ Firebase åŠ å…¥éŠæˆ²
        await setDoc(doc(db, 'games', GAME_ID, 'players', myId), {
            name: myName,
            avatar: myAvatar,
            x: Math.random() * (mapWidth - 100) + 50,
            y: Math.random() * (mapHeight - 100) + 50,
            angle: 0,
            hp: 100,
            lastSeen: serverTimestamp()
        });
        
        // 3. ç›£è½ Firebase æ›´æ–°
        listenToGame();

        // 4. å•Ÿå‹•éŠæˆ²è¿´åœˆ (ç¹ªåœ–)
        requestAnimationFrame(gameLoop);

        // 5. å•Ÿå‹•ä½ç½®ä¸Šå‚³è¿´åœˆ (æ¯100msä¸Šå‚³ä¸€æ¬¡ï¼Œé¿å…çˆ†æµé‡)
        setInterval(uploadPosition, 100);
    };

    // --- æ–æ¡¿æ§åˆ¶ ---
    let moveData = { speed: 0, angle: 0, active: false };
    function initJoystick() {
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-zone'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'white'
        });

        joystick.on('move', (evt, data) => {
            moveData.active = true;
            moveData.angle = data.angle.radian; // å¼§åº¦
            moveData.speed = Math.min(data.distance, 50) / 10; // é€Ÿåº¦ä¿‚æ•¸
            myPos.angle = moveData.angle; // è§’è‰²é¢å‘ç§»å‹•æ–¹å‘
        });

        joystick.on('end', () => {
            moveData.active = false;
        });
    }

    // --- æ”»æ“Šèˆ‡ç­”é¡Œç³»çµ± ---
    const questionBank = [
        { q: "å¤ªé™½å¾å“ªé‚Šå‡èµ·ï¼Ÿ", opt: ["æ±", "å—", "è¥¿"], ans: 0 },
        { q: "æ°´åœ¨æ”æ°å¤šå°‘åº¦æ²¸é¨°ï¼Ÿ", opt: ["50åº¦", "90åº¦", "100åº¦"], ans: 2 },
        { q: "é’é¦¬å¤§æ©‹é€£æ¥å“ªè£¡ï¼Ÿ", opt: ["é’è¡£èˆ‡é¦¬ç£", "é’è¡£èˆ‡å¤§å¶¼å±±", "é¦¬ç£èˆ‡å¤§å¶¼å±±"], ans: 0 }
    ];

    window.handleAttack = () => {
        if (ammo > 0) {
            fireBullet();
        } else {
            showQuestion();
        }
    };

    function showQuestion() {
        const modal = document.getElementById('quiz-modal');
        const qText = document.getElementById('q-text');
        const qOptions = document.getElementById('q-options');
        
        // éš¨æ©Ÿé¸é¡Œ
        const q = questionBank[Math.floor(Math.random() * questionBank.length)];
        qText.innerText = q.q;
        qOptions.innerHTML = '';
        
        q.opt.forEach((optText, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = optText;
            btn.onclick = () => {
                if (idx === q.ans) {
                    ammo = 3; // ç­”å°é€3ç™¼
                    updateAmmoUI();
                    modal.style.display = 'none';
                } else {
                    alert("ç­”éŒ¯äº†ï¼");
                    modal.style.display = 'none';
                }
            };
            qOptions.appendChild(btn);
        });
        
        modal.style.display = 'block';
    }

    function updateAmmoUI() {
        const btn = document.getElementById('attack-btn');
        const indicator = document.getElementById('ammo-indicator');
        indicator.innerText = `å½ˆè—¥: ${ammo}`;
        if (ammo > 0) {
            btn.classList.add('active');
            btn.innerText = "ğŸ”¥";
        } else {
            btn.classList.remove('active');
            btn.innerText = "âš”ï¸";
        }
    }

    // ç™¼å°„å­å½ˆ
    function fireBullet() {
        ammo--;
        updateAmmoUI();
        
        // å‰µå»ºå­å½ˆç‰©ä»¶
        const bullet = {
            id: Date.now() + Math.random(),
            owner: myId,
            x: myPos.x,
            y: myPos.y,
            vx: Math.cos(myPos.angle) * 8, // å­å½ˆé€Ÿåº¦
            vy: Math.sin(myPos.angle) * 8 * -1, // Canvas Yè»¸ç›¸å
            life: 60 // å­˜æ´»å¹€æ•¸
        };
        
        bullets.push(bullet);
        
        // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘åªåœ¨æœ¬åœ°ç”Ÿæˆå­å½ˆä¸¦è™•ç†ç¢°æ’ï¼Œç„¶å¾Œå‘Šè¨´ Server å°æ–¹æ‰£è¡€
        // é€™æ¨£å¯ä»¥çœä¸‹æŠŠæ¯é¡†å­å½ˆéƒ½å¯«å…¥è³‡æ–™åº«çš„å·¨å¤§æˆæœ¬
    }

    // --- Firebase åŒæ­¥ ---
    function listenToGame() {
        onSnapshot(collection(db, 'games', GAME_ID, 'players'), (snapshot) => {
            snapshot.forEach(doc => {
                const data = doc.data();
                if (doc.id === myId) {
                    // åŒæ­¥è‡ªå·±çš„è¡€é‡ (å¦‚æœæœ‰è®Šå‹•)
                    if (data.hp <= 0) {
                        alert("ä½ è¢«æ‰“æ•—äº†ï¼");
                        location.reload();
                    }
                    // æ›´æ–°æœ¬åœ°åº§æ¨™åŸºæ–¼æœ€æ–°çš„ Server æ•¸æ“š (é˜²æ­¢åå·®å¤ªå¤§ï¼Œä½†ä¸»è¦é‚„æ˜¯é æœ¬åœ°è¨ˆç®—)
                    // é€™è£¡ç°¡åŒ–ï¼šåªæ›´æ–°HPï¼Œä¸å¼·åˆ¶è¦†è“‹æœ¬åœ°ç§»å‹•ä½ç½®ä»¥å…æŠ–å‹•
                    document.getElementById('status-bar').innerText = `HP: ${data.hp} | ${myName}`;
                } else {
                    players[doc.id] = data; // æ›´æ–°å…¶ä»–ç©å®¶
                }
            });
        });
    }

    function uploadPosition() {
        if (!myId) return;
        updateDoc(doc(db, 'games', GAME_ID, 'players', myId), {
            x: myPos.x,
            y: myPos.y,
            angle: moveData.angle,
            lastSeen: serverTimestamp()
        });
    }

    // --- éŠæˆ²ä¸»è¿´åœˆ (Game Loop) ---
    function gameLoop() {
        // 1. æ¸…ç©ºç•«å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. ç§»å‹•è‡ªå·±
        if (moveData.active) {
            myPos.x += Math.cos(moveData.angle) * moveData.speed;
            myPos.y -= Math.sin(moveData.angle) * moveData.speed;
            
            // é‚Šç•Œæª¢æŸ¥
            myPos.x = Math.max(20, Math.min(canvas.width - 20, myPos.x));
            myPos.y = Math.max(20, Math.min(canvas.height - 20, myPos.y));
        }

        // 3. ç¹ªè£½è‡ªå·±
        drawPlayer(myPos.x, myPos.y, myAvatar, myName, true, myPos.angle);

        // 4. ç¹ªè£½å…¶ä»–ç©å®¶
        for (let pid in players) {
            const p = players[pid];
            if (p.hp > 0) {
                drawPlayer(p.x, p.y, p.avatar, p.name, false, p.angle || 0);
            }
        }

        // 5. æ›´æ–°ä¸¦ç¹ªè£½å­å½ˆ
        updateBullets();

        requestAnimationFrame(gameLoop);
    }

    function drawPlayer(x, y, avatar, name, isMe, angle) {
        ctx.save();
        ctx.translate(x, y);
        
        // ç¹ªè£½è¡€æ¢
        ctx.fillStyle = "red";
        ctx.fillRect(-20, -35, 40, 5);
        ctx.fillStyle = "#2ecc71";
        ctx.fillRect(-20, -35, 40, 5); // é€™è£¡æ‡‰è©²æ ¹æ“š HP ç™¾åˆ†æ¯”ç¹ªè£½ï¼Œç°¡åŒ–èµ·è¦‹ç•«æ»¿

        // ç¹ªè£½åå­—
        ctx.fillStyle = "white";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(name, 0, -40);

        // ç¹ªè£½æœ¬é«” (Emoji)
        ctx.font = "30px Arial";
        ctx.textBaseline = "middle";
        ctx.fillText(avatar, 0, 0);

        // ç¹ªè£½æ–¹å‘ç®­é ­
        ctx.rotate(-angle); // é€†æ™‚é‡æ—‹è½‰ä»¥åŒ¹é… Nipple.js è§’åº¦
        ctx.beginPath();
        ctx.moveTo(20, 0);
        ctx.lineTo(30, 0);
        ctx.strokeStyle = isMe ? "#f1c40f" : "white";
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.restore();
    }

    function updateBullets() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.x += b.vx;
            b.y += b.vy;
            b.life--;

            // ç¹ªè£½å­å½ˆ
            ctx.beginPath();
            ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
            ctx.fillStyle = "orange";
            ctx.fill();

            // ç°¡å–®ç¢°æ’æª¢æ¸¬ (åªç”±æ”»æ“Šæ–¹æª¢æŸ¥)
            if (b.owner === myId) {
                for (let pid in players) {
                    const p = players[pid];
                    if (p.hp > 0) {
                        const dist = Math.hypot(b.x - p.x, b.y - p.y);
                        if (dist < 30) { // æ“Šä¸­åŠå¾‘
                            // æ“Šä¸­ï¼é€šçŸ¥ Server æ‰£è¡€
                            console.log("Hit " + p.name);
                            const targetRef = doc(db, 'games', GAME_ID, 'players', pid);
                            // ç”¨ transaction æ¯”è¼ƒå®‰å…¨ï¼Œé€™è£¡ç°¡åŒ–ç”¨ update
                            // æ³¨æ„ï¼šçœŸå¯¦éŠæˆ²æ‡‰ç”± Server Function è™•ç†å‚·å®³é˜²æ­¢ä½œå¼Š
                            updateDoc(targetRef, { hp: p.hp - 10 }); 
                            
                            b.life = 0; // å­å½ˆæ¶ˆå¤±
                            break;
                        }
                    }
                }
            }

            if (b.life <= 0) {
                bullets.splice(i, 1);
            }
        }
    }
</script>
</body>
</html>