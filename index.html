<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¸è­˜å¤§äº‚é¬¥ - ç”Ÿå­˜æŒ‘æˆ°</title>
    <style>
        /* ç°¡å–®çš„éŠæˆ²é¢¨æ ¼ CSS */
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #2c3e50; color: #ecf0f1; text-align: center; padding: 20px; }
        h1 { color: #e74c3c; }
        .container { max-width: 800px; margin: 0 auto; background-color: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        /* ç™»å…¥å€å¡Š */
        #login-section { margin-top: 50px; }
        input, button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; margin: 5px; }
        button { background-color: #3498db; color: white; cursor: pointer; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }
        button.attack-btn { background-color: #e74c3c; font-weight: bold; animation: pulse 1s infinite; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; animation: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* éŠæˆ²å€å¡Š */
        #game-section { display: none; /* é è¨­éš±è— */ }
        
        /* ç©å®¶åˆ—è¡¨å€å¡Š */
        .players-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .player-card { background-color: #2c3e50; padding: 15px; border-radius: 8px; border: 2px solid #7f8c8d; position: relative; }
        .player-card.is-me { border-color: #f1c40f; } /* æ¨™è¨˜è‡ªå·± */
        .player-card.eliminated { opacity: 0.5; filter: grayscale(100%); }
        .player-name { font-weight: bold; margin-bottom: 5px; display: block; }
        
        /* è¡€é‡æ¢ */
        .health-bar-container { background-color: #95a5a6; height: 10px; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .health-bar-fill { height: 100%; background-color: #2ecc71; transition: width 0.5s ease-in-out; }
        .health-text { font-size: 12px; }

        /* å•é¡Œå€å¡Š */
        #question-area { background-color: #e67e22; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        #question-text { font-size: 1.2em; margin-bottom: 15px; font-weight: bold; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { background-color: #d35400; }
        .option-btn:hover { background-color: #a04000; }

        /* ç‹€æ…‹è¨Šæ¯ */
        #status-message { margin-bottom: 20px; font-size: 1.1em; color: #f1c40f; min-height: 1.2em;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¥ å¸¸è­˜å¤§äº‚é¬¥ ğŸ”¥</h1>

    <div id="login-section">
        <p>è¼¸å…¥ä½ çš„åå­—åŠ å…¥æˆ°å ´ï¼</p>
        <input type="text" id="username-input" placeholder="ä½ çš„åå­— (ä¾‹å¦‚: å°æ˜)">
        <button id="join-btn">åŠ å…¥éŠæˆ²</button>
    </div>

    <div id="game-section">
        <div id="status-message">ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...</div>
        
        <div id="question-area">
            <div id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div class="options-grid" id="options-container">
                </div>
        </div>

        <h3>å­˜æ´»ç©å®¶åˆ—è¡¨ (é»æ“Šç´…è‰²æŒ‰éˆ•æ”»æ“Š!)</h3>
        <div class="players-grid" id="players-list">
            </div>
    </div>
</div>

<script type="module">
    // å°å…¥å¿…è¦çš„ Firebase å‡½æ•¸
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        setDoc, 
        updateDoc, 
        onSnapshot, 
        increment,
        deleteField,
        getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: è€å¸«è«‹å°‡é€™è£¡æ›¿æ›æˆæ‚¨è‡ªå·±çš„ Firebase é …ç›®é…ç½®è¨­å®š
    // è«‹å¾ Firebase Console -> Project Settings -> General -> Your apps ä¸‹æ–¹è¤‡è£½
const firebaseConfig = {
  apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
  authDomain: "gsmoney-65f2f.firebaseapp.com",
  projectId: "gsmoney-65f2f",
  storageBucket: "gsmoney-65f2f.firebasestorage.app",
  messagingSenderId: "176138167950",
  appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
  measurementId: "G-BKB004KPBN"
};


    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ================= éŠæˆ²è®Šæ•¸èˆ‡è¨­å®š =================
    const GAME_ID = "class_room_1"; // ç°¡åŒ–èµ·è¦‹ï¼Œæˆ‘å€‘å›ºå®šä¸€å€‹æˆ¿é–“ ID
    let myPlayerId = "player_" + Math.random().toString(36).substr(2, 9); // éš¨æ©Ÿç”¢ç”Ÿæˆ‘çš„ ID
    let myName = "";
    let amIAlive = true;
    let hasAttackChance = false; // æ˜¯å¦æ“æœ‰æ”»æ“Šæ©Ÿæœƒ
    const INITIAL_HEALTH = 100;
    const DAMAGE_PER_HIT = 20; // æ¯æ¬¡æ”»æ“Šæ‰£å¤šå°‘è¡€

    // è€å¸«çš„é¡Œåº« (æ‚¨å¯ä»¥éš¨æ„æ“´å……)
    const questionBank = [
        { q: "é¦™æ¸¯ä½æ–¼ä¸­åœ‹çš„å“ªå€‹æ–¹å‘ï¼Ÿ", options: ["æ±æ–¹", "å—æ–¹", "è¥¿æ–¹", "åŒ—æ–¹"], ans: 1 },
        { q: "ä¸‹é¢å“ªä¸€ç¨®ä¸æ˜¯å¯å›æ”¶ç‰©ï¼Ÿ", options: ["é‹ç½", "å»¢ç´™", "å»šé¤˜", "è† æ¨½"], ans: 2 },
        { q: "äººé«”æœ€å¤§çš„å™¨å®˜æ˜¯ä»€éº¼ï¼Ÿ", options: ["å¿ƒè‡Ÿ", "å¤§è…¦", "çš®è†š", "è‚è‡Ÿ"], ans: 2 },
        { q: "å¤ªé™½ç³»ä¸­æœ€å¤§çš„è¡Œæ˜Ÿæ˜¯ï¼Ÿ", options: ["åœ°çƒ", "ç«æ˜Ÿ", "æœ¨æ˜Ÿ", "åœŸæ˜Ÿ"], ans: 2 },
        { q: "é é˜²æµæ„Ÿï¼Œæˆ‘å€‘æ‡‰è©²ç¶“å¸¸ï¼Ÿ", options: ["æ´—æ‰‹", "ç†¬å¤œ", "åƒç³–", "æ‰çœ¼ç›"], ans: 0 }
    ];
    let currentQuestion = null;

    // ================= DOM å…ƒç´  =================
    const loginSection = document.getElementById('login-section');
    const gameSection = document.getElementById('game-section');
    const joinBtn = document.getElementById('join-btn');
    const usernameInput = document.getElementById('username-input');
    const playersListDiv = document.getElementById('players-list');
    const statusMessage = document.getElementById('status-message');
    const questionArea = document.getElementById('question-area');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');

    // ================= éŠæˆ²é‚è¼¯å‡½æ•¸ =================

    // 1. åŠ å…¥éŠæˆ²
    joinBtn.addEventListener('click', async () => {
        myName = usernameInput.value.trim();
        if (!myName) return alert("è«‹è¼¸å…¥åå­—ï¼");

        loginSection.style.display = 'none';
        gameSection.style.display = 'block';
        statusMessage.textContent = "æ­£åœ¨åŠ å…¥æˆ°å ´...";

        // åœ¨ Firestore ä¸­å»ºç«‹æˆ‘çš„ç©å®¶è³‡æ–™
        const playerRef = doc(db, 'games', GAME_ID, 'players', myPlayerId);
        await setDoc(playerRef, {
            name: myName,
            health: INITIAL_HEALTH,
            isAlive: true,
            lastUpdated: Date.now()
        });

        statusMessage.textContent = "å·²åŠ å…¥ï¼æº–å‚™æˆ°é¬¥ï¼";
        setupRealtimeListener(); // é–‹å§‹ç›£è½è³‡æ–™åº«è®ŠåŒ–
        showNextQuestion(); // é¡¯ç¤ºç¬¬ä¸€é¡Œ
    });


    // 2. å¯¦æ™‚ç›£è½ Firebase è³‡æ–™è®ŠåŒ– (æ ¸å¿ƒåŠŸèƒ½)
    function setupRealtimeListener() {
        // ç›£è½ 'players' é›†åˆçš„è®ŠåŒ–
        const playersColRef = collection(db, 'games', GAME_ID, 'players');
        onSnapshot(playersColRef, (snapshot) => {
            playersListDiv.innerHTML = ''; // æ¸…ç©ºèˆŠåˆ—è¡¨
            let aliveCount = 0;
            let winnerName = "";

            snapshot.forEach(doc => {
                const playerData = doc.data();
                const playerId = doc.id;
                if (playerData.isAlive) {
                    aliveCount++;
                    winnerName = playerData.name;
                }
                // ç¹ªè£½ç©å®¶å¡ç‰‡
                renderPlayerCard(playerId, playerData);
            });

            // æ›´æ–°æˆ‘çš„ç”Ÿå­˜ç‹€æ…‹
            const myData = snapshot.docs.find(d => d.id === myPlayerId)?.data();
            if (myData) {
                amIAlive = myData.isAlive;
                if (!amIAlive) {
                    statusMessage.textContent = "ä½ å·²ç¶“è¢«æ·˜æ±°äº†ï¼è§€æˆ°æ¨¡å¼ä¸­...";
                    questionArea.style.display = 'none'; // æ·˜æ±°å¾Œä¸èƒ½å†ç­”é¡Œ
                }
            }

            // åˆ¤æ–·éŠæˆ²æ˜¯å¦çµæŸ (åªå‰©ä¸€äºº)
            if (aliveCount === 1 && snapshot.size > 1) {
                 statusMessage.innerHTML = `ğŸ‰ éŠæˆ²çµæŸï¼æœ€å¾Œå‹åˆ©è€…æ˜¯ï¼š<span style="color:#f1c40f; font-size:1.5em">${winnerName}</span> ğŸ‰`;
                 questionArea.style.display = 'none';
            }
        });
    }

    // 3. ç¹ªè£½ç©å®¶å¡ç‰‡ UI
    function renderPlayerCard(playerId, playerData) {
        const isMe = playerId === myPlayerId;
        const healthPercent = (playerData.health / INITIAL_HEALTH) * 100;
        const card = document.createElement('div');
        card.className = `player-card ${isMe ? 'is-me' : ''} ${!playerData.isAlive ? 'eliminated' : ''}`;
        
        // æ”»æ“ŠæŒ‰éˆ•ç‹€æ…‹ï¼šæˆ‘æ´»è‘— + æˆ‘æœ‰æ”»æ“Šæ©Ÿæœƒ + å°æ–¹æ´»è‘— + å°æ–¹ä¸æ˜¯æˆ‘
        const canAttackThisPlayer = amIAlive && hasAttackChance && playerData.isAlive && !isMe;
        
        card.innerHTML = `
            <span class="player-name">${playerData.name}${isMe ? ' (æˆ‘)' : ''}</span>
            <div class="health-bar-container">
                <div class="health-bar-fill" style="width: ${healthPercent}%; background-color: ${healthPercent < 30 ? '#e74c3c' : '#2ecc71'}"></div>
            </div>
            <span class="health-text">${playerData.health} / ${INITIAL_HEALTH} HP</span>
            <button class="${canAttackThisPlayer ? 'attack-btn' : ''}" 
                    ${canAttackThisPlayer ? '' : 'disabled'} 
                    onclick="attackTarget('${playerId}')">
                    ${!playerData.isAlive ? 'å·²æ·˜æ±°' : 'æ”»æ“Š!'}
            </button>
        `;
        playersListDiv.appendChild(card);
    }

    // 4. é¡¯ç¤ºé¡Œç›®
    function showNextQuestion() {
        if (!amIAlive) return;
        // éš¨æ©Ÿé¸é¡Œ (æ­£å¼ç‰ˆæ‡‰è©²ç”±è€å¸«æ§åˆ¶æˆ–ä¾åºå‡ºé¡Œ)
        currentQuestion = questionBank[Math.floor(Math.random() * questionBank.length)];
        
        questionText.textContent = currentQuestion.q;
        optionsContainer.innerHTML = '';
        currentQuestion.options.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = option;
            btn.onclick = () => checkAnswer(index);
            optionsContainer.appendChild(btn);
        });
        questionArea.style.display = 'block';
        statusMessage.textContent = "è«‹å›ç­”å•é¡Œä»¥ç²å–æ”»æ“Šæ©Ÿæœƒï¼";
    }

    // 5. æª¢æŸ¥ç­”æ¡ˆ
    function checkAnswer(selectedIndex) {
        if (selectedIndex === currentQuestion.ans) {
            // ç­”å°äº†ï¼
            hasAttackChance = true;
            statusMessage.innerHTML = "âœ… ç­”å°äº†ï¼<span style='color:#e74c3c'>ç¾åœ¨é»æ“Šä¸‹æ–¹ç´…è‰²æŒ‰éˆ•æ”»æ“Šå°æ‰‹ï¼</span>";
            questionArea.style.display = 'none'; // æš«æ™‚éš±è—é¡Œç›®ï¼Œç­‰å¾…æ”»æ“Š
            // å¼·åˆ¶åˆ·æ–°ä¸€ä¸‹ UI ä»¥å•Ÿç”¨æŒ‰éˆ• (é›–ç„¶ onSnapshot æœƒè™•ç†ï¼Œä½†é€™æ¨£åæ‡‰æ›´å¿«)
            document.querySelectorAll('.player-card button').forEach(btn => {
                 // é€™è£¡çš„é‚è¼¯æ¯”è¼ƒç°¡åŒ–ï¼Œå¯¦éš›ä¸Šä¾è³´å³æ™‚ç›£è½å™¨é‡æ–°ç¹ªè£½æœƒæ›´å¥½
                 // ç‚ºäº† demo ç°¡å–®ï¼Œæˆ‘å€‘è§¸ç™¼ä¸€æ¬¡è³‡æ–™æ›´æ–°ä¾†å¼·åˆ¶é‡ç¹ª
                 updateDoc(doc(db, 'games', GAME_ID, 'players', myPlayerId), { lastUpdated: Date.now() });
            });

        } else {
            // ç­”éŒ¯äº†ï¼
            statusMessage.textContent = "âŒ ç­”éŒ¯äº†ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚";
            // ç°¡å–®æ‡²ç½°ï¼šç­‰ 2 ç§’æ‰èƒ½å†ç­”
            questionArea.style.display = 'none';
            setTimeout(() => {
                 if(amIAlive) questionArea.style.display = 'block';
            }, 2000);
        }
    }

    // 6. åŸ·è¡Œæ”»æ“Š (éœ€è¦å°‡æ­¤å‡½æ•¸æ›è¼‰åˆ° window ç‰©ä»¶ä»¥ä¾¿ HTML onclick èª¿ç”¨)
    window.attackTarget = async function(targetId) {
        if (!hasAttackChance || !amIAlive) return;

        const targetRef = doc(db, 'games', GAME_ID, 'players', targetId);

        try {
            // ä½¿ç”¨ Firestore äº‹å‹™ (Transaction) ç¢ºä¿æ‰£è¡€æ˜¯åŸå­æ“ä½œï¼Œé¿å…ä¸¦ç™¼å•é¡Œ
            await db.runTransaction(async (transaction) => {
                const targetDoc = await transaction.get(targetRef);
                if (!targetDoc.exists()) throw "å°æ‰‹ä¸å­˜åœ¨!";
                
                let newHealth = targetDoc.data().health - DAMAGE_PER_HIT;
                let isAlive = true;
                if (newHealth <= 0) {
                    newHealth = 0;
                    isAlive = false;
                }

                transaction.update(targetRef, { 
                    health: newHealth,
                    isAlive: isAlive
                });
            });

            statusMessage.textContent = `âš”ï¸ æ”»æ“ŠæˆåŠŸï¼ä½ å°ç›®æ¨™é€ æˆäº† ${DAMAGE_PER_HIT} é»å‚·å®³ã€‚`;
            hasAttackChance = false; // ç”¨æ‰æ”»æ“Šæ©Ÿæœƒ
            
            // æº–å‚™ä¸‹ä¸€é¡Œ (å»¶é²ä¸€ä¸‹è®“ç©å®¶çœ‹åˆ°æ”»æ“Šçµæœ)
            setTimeout(showNextQuestion, 1500);

        } catch (e) {
            console.error("æ”»æ“Šå¤±æ•—:", e);
            statusMessage.textContent = "æ”»æ“Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

</script>

</body>
</html>