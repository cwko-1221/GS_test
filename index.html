<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¿åºœç†è²¡å¤§ä½œæˆ° (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; background: #f0f0f0; }
        #menuScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 15px 30px; margin: 10px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; color: white; width: 80%; max-width: 300px; }
        .btn-student { background: #2196F3; }
        .btn-teacher { background: #FF9800; }
        input { padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; width: 70%; max-width: 280px; text-align: center; }
        #teacherScreen, #gameScreen { display: none; width: 100%; height: 100%; }
        #teacherScreen { padding-top: 20px; text-align: center; overflow-y: auto; }
        #qrcode { margin: 20px auto; display: flex; justify-content: center; }
        .rank-item { background: #eee; padding: 10px; margin: 5px auto; width: 80%; border-radius: 5px; text-align: left; font-size: 18px; }
        #questionModal { display: none; position: fixed; top: 10%; left: 5%; width: 90%; background: white; border: 4px solid #FF5722; border-radius: 15px; padding: 20px; box-sizing: border-box; text-align: center; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .opt-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 18px; }
    </style>
</head>
<body>

    <div id="menuScreen">
        <h1>ğŸ’° æ”¿åºœç†è²¡å¤§ä½œæˆ°</h1>
        <p style="color:red">ç³»çµ±è¨ºæ–·ç‰ˆ v3</p>
        <input type="text" id="playerName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" maxlength="8">
        <button class="btn btn-student" onclick="joinGame()">æˆ‘æ˜¯å­¸ç”Ÿ (é€²å…¥éŠæˆ²)</button>
        <br>
        <button class="btn btn-teacher" onclick="startTeacherMode()">æˆ‘æ˜¯è€å¸« (ä¸»æŒéŠæˆ²)</button>
        <div id="debugLog" style="margin-top:20px; font-size:12px; color:#666; width:80%; word-break:break-all;"></div>
    </div>

    <div id="teacherScreen">
        <h2>æƒæåŠ å…¥éŠæˆ²</h2>
        <div id="qrcode"></div>
        <h3 id="joinLink"></h3>
        <p id="teacherStatus" style="color:blue">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</p>
        <button class="btn btn-teacher" onclick="resetGame()" style="background: #f44336;">é‡ç½®æ‰€æœ‰ç©å®¶</button>
        <hr>
        <h3>ğŸ† å¯¦æ™‚æ’è¡Œæ¦œ</h3>
        <div id="leaderboard"></div>
    </div>

    <div id="gameScreen">
        <canvas id="canvas"></canvas>
        <div id="questionModal">
            <h2 id="qTitle">é¡Œç›®</h2>
            <div id="qOptions"></div>
        </div>
    </div>

    <script>
        // é™¤éŒ¯æ—¥èªŒåŠŸèƒ½
        function log(msg) {
            console.log(msg);
            document.getElementById('debugLog').innerText += "\n" + msg;
        }

        // ================= CONFIG (å·²ä¿®æ­£) =================
        const firebaseConfig = {
            apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
            authDomain: "gsmoney-65f2f.firebaseapp.com",
            projectId: "gsmoney-65f2f",
            storageBucket: "gsmoney-65f2f.firebasestorage.app",
            messagingSenderId: "176138167950",
            appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
            measurementId: "G-BKB004KPBN"
        };
        // ==================================================

        let db, playersRef, gameRef;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            playersRef = db.ref('players');
            gameRef = db.ref('gameState');
            log("Firebase åˆå§‹åŒ–æˆåŠŸ");
            
            // æ¸¬è©¦é€£ç·š
            db.ref('.info/connected').on('value', snap => {
                if (snap.val() === true) {
                    log("âœ… æˆåŠŸé€£ç·šåˆ°è³‡æ–™åº«ä¼ºæœå™¨");
                    document.getElementById('teacherStatus').innerText = "âœ… è³‡æ–™åº«é€£ç·šæ­£å¸¸";
                    document.getElementById('teacherStatus').style.color = "green";
                } else {
                    log("âš ï¸ æ­£åœ¨å˜—è©¦é€£ç·š...");
                }
            });

        } catch (e) {
            alert("åš´é‡éŒ¯èª¤ï¼šFirebase åˆå§‹åŒ–å¤±æ•—\n" + e.message);
            log("åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }

        // é¡Œç›®åº«
        const questions = [
            { q: "æ”¿åºœç†è²¡çš„é¦–è¦åŸå‰‡æ˜¯ä»€éº¼ï¼Ÿ", opts: ["é‡å…¥ç‚ºå‡º", "å…ˆä½¿æœªä¾†éŒ¢", "éš¨æ„æ¶ˆè²»"], ans: 0 },
            { q: "æ‰“å·¥ä»”æ¯æœˆæœ‰è–ªé‡‘ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["åˆ©å¾—ç¨…", "è–ªä¿¸ç¨…", "å°èŠ±ç¨…"], ans: 1 },
            { q: "å…¬å¸è³ºå–åˆ©æ½¤å¾Œï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["è–ªä¿¸ç¨…", "å°èŠ±ç¨…", "åˆ©å¾—ç¨…"], ans: 2 },
            { q: "è²·è³£æ¨“å®‡ä½å®…æ™‚ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["å°èŠ±ç¨…", "åœ°åƒ¹ç¨…", "å¢å€¼ç¨…"], ans: 0 },
            { q: "æ”¿åºœæ”¶å…¥æ¯”é–‹æ”¯å¤šï¼Œç¨±ç‚ºï¼Ÿ", opts: ["èµ¤å­—", "ç›ˆé¤˜", "ç ´ç”¢"], ans: 1 },
            { q: "ã€Œç›ˆé¤˜ã€æœƒæ’¥å…¥å“ªè£¡ï¼Ÿ", opts: ["è²¡æ”¿å„²å‚™", "éŠ€è¡Œ", "å®˜å“¡å£è¢‹"], ans: 0 },
            { q: "ä»¥ä¸‹å“ªé …ä¸æ˜¯é¦™æ¸¯ä¸»è¦é–‹æ”¯ï¼Ÿ", opts: ["æ•™è‚²", "è»è²»", "é†«ç™‚"], ans: 1 },
            { q: "èˆˆå»ºå¤§æ©‹å±¬æ–¼å“ªé¡é–‹æ”¯ï¼Ÿ", opts: ["ç¤¾æœƒç¦åˆ©", "åŸºç¤å»ºè¨­", "ä¿å®‰"], ans: 1 },
            { q: "äº«ç”¨è¨­æ–½æ˜¯æ¬Šåˆ©ï¼Œç¹³ç¨…æ˜¯ï¼Ÿ", opts: ["èˆˆè¶£", "é¸æ“‡", "ç¾©å‹™"], ans: 2 },
            { q: "é•·æœŸã€Œå…¥ä¸æ•·å‡ºã€æœƒå°è‡´ï¼Ÿ", opts: ["è²¡æ”¿èµ¤å­—", "ç¶“æ¿Ÿç¹æ¦®", "ç¨…æ”¶æ¸›å°‘"], ans: 0 }
        ];

        let myId = null;
        let me = { x: 0, y: 0, r: 20, color: '' };
        let allPlayers = {};
        const WORLD_SIZE = 2000;
        let canvas, ctx;

        // ================= è€å¸«é‚è¼¯ =================
        function startTeacherMode() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('teacherScreen').style.display = 'block';

            const url = window.location.href;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
            document.getElementById("joinLink").innerText = "ç¶²å€: " + window.location.host;

            // ç›£è½ä¸¦æ•æ‰éŒ¯èª¤
            playersRef.on('value', (snap) => {
                const list = document.getElementById('leaderboard');
                list.innerHTML = "";
                const data = snap.val() || {};
                const sorted = Object.values(data).sort((a, b) => b.r - a.r);
                
                if(sorted.length === 0) list.innerHTML = "<div>ç­‰å¾…å­¸ç”ŸåŠ å…¥...</div>";

                sorted.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'rank-item';
                    div.innerHTML = `ç¬¬ ${i+1} å: <strong>${p.name}</strong> (${Math.floor(p.r)})`;
                    list.appendChild(div);
                });
            }, (error) => {
                alert("è®€å–å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase Rulesã€‚\néŒ¯èª¤ä»£ç¢¼ï¼š" + error.code);
            });

            setInterval(() => {
                const qIdx = Math.floor(Math.random() * questions.length);
                gameRef.set({
                    questionId: Date.now(),
                    index: qIdx,
                    timestamp: Date.now()
                }).catch(e => console.error("å‡ºé¡Œå¤±æ•—", e));
            }, 15000);
        }

        function resetGame() {
            if(confirm("é‡ç½®ï¼Ÿ")) {
                playersRef.remove().catch(e => alert("é‡ç½®å¤±æ•—ï¼š" + e.message));
            }
        }

        // ================= å­¸ç”Ÿé‚è¼¯ =================
        function joinGame() {
            const name = document.getElementById('playerName').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
            
            // å˜—è©¦å¯«å…¥è³‡æ–™åº«æ¸¬è©¦æ¬Šé™
            const testRef = playersRef.push();
            myId = testRef.key;
            me.name = name;
            me.x = Math.random() * WORLD_SIZE;
            me.y = Math.random() * WORLD_SIZE;
            me.color = `hsl(${Math.random() * 360}, 80%, 60%)`;

            testRef.set({
                name: me.name,
                x: me.x,
                y: me.y,
                r: me.r,
                color: me.color
            })
            .then(() => {
                // å¯«å…¥æˆåŠŸï¼Œé€²å…¥éŠæˆ²
                document.getElementById('menuScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                startGameLoop();
            })
            .catch((error) => {
                // å¯«å…¥å¤±æ•—ï¼Œå½ˆå‡ºè­¦å‘Š
                alert("ç„¡æ³•åŠ å…¥éŠæˆ²ï¼\nåŸå› ï¼š" + error.message + "\n\nè«‹è€å¸«æª¢æŸ¥ Firebase Database Rules æ˜¯å¦å·²è¨­ç‚º trueã€‚");
                log("å¯«å…¥å¤±æ•—: " + error.message);
            });
        }

        function updateMyData() {
            if(!myId) return;
            playersRef.child(myId).set({
                name: me.name,
                x: me.x,
                y: me.y,
                r: me.r,
                color: me.color
            }); // é€™è£¡ä¸åŠ  catch é¿å… loop ä¸­ä¸€ç›´å½ˆçª—
        }

        function startGameLoop() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            playersRef.on('value', snap => {
                allPlayers = snap.val() || {};
                checkCollisions();
            });

            gameRef.on('value', snap => {
                const data = snap.val();
                if(data && Date.now() - data.timestamp < 5000) {
                    showQuestion(data.index);
                }
            });

            requestAnimationFrame(gameLoop);
            setInterval(updateMyData, 100);
            
            // ç¶å®šè¼¸å…¥
            window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
            window.addEventListener('touchmove', e => {
                e.preventDefault();
                mouseX = e.touches[0].clientX;
                mouseY = e.touches[0].clientY;
            }, {passive: false});
        }

        let mouseX = window.innerWidth / 2, mouseY = window.innerHeight / 2;

        function gameLoop() {
            const dx = mouseX - window.innerWidth / 2;
            const dy = mouseY - window.innerHeight / 2;
            const angle = Math.atan2(dy, dx);
            const speed = 50 / me.r + 2; 

            me.x += Math.cos(angle) * speed;
            me.y += Math.sin(angle) * speed;
            me.x = Math.max(0, Math.min(WORLD_SIZE, me.x));
            me.y = Math.max(0, Math.min(WORLD_SIZE, me.y));

            drawGame();
            requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width/2 - me.x, canvas.height/2 - me.y);
            ctx.strokeStyle = "#ccc";
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

            for (let id in allPlayers) {
                const p = allPlayers[id];
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.fillStyle = "#000";
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText(p.name, p.x, p.y - p.r - 5);
            }
            ctx.restore();
        }

        function checkCollisions() {
            for (let id in allPlayers) {
                if (id === myId) continue;
                const p = allPlayers[id];
                const dist = Math.hypot(me.x - p.x, me.y - p.y);
                if (dist < me.r && me.r > p.r * 1.2) {
                    me.r += p.r * 0.2; 
                    playersRef.child(id).remove();
                }
            }
            if (!allPlayers[myId] && myId) {
                me.x = Math.random() * WORLD_SIZE;
                me.y = Math.random() * WORLD_SIZE;
                me.r = 20;
                // updateMyData æœƒåœ¨ loop ä¸­è‡ªå‹•ä¿®å¾©
            }
        }

        function showQuestion(index) {
            const q = questions[index];
            const modal = document.getElementById('questionModal');
            const content = document.getElementById('qOptions');
            document.getElementById('qTitle').innerText = q.q;
            content.innerHTML = "";
            modal.style.display = 'block';

            q.opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    modal.style.display = 'none';
                    if (i === q.ans) {
                        me.r += 10; 
                        alert("ç­”å°äº†ï¼é«”ç©è®Šå¤§ï¼");
                    } else {
                        alert("ç­”éŒ¯äº†...");
                    }
                };
                content.appendChild(btn);
            });
        }
    </script>
</body>
</html>