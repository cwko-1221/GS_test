<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ”¿åºœç†è²¡å¤§ä½œæˆ°</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; background: #f0f0f0; }
        
        /* ç™»å…¥èˆ‡é¸å–®ç•«é¢ */
        #menuScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 15px 30px; margin: 10px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; color: white; width: 80%; max-width: 300px; }
        .btn-student { background: #2196F3; }
        .btn-teacher { background: #FF9800; }
        input { padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; width: 70%; max-width: 280px; text-align: center; }

        /* è€å¸«ç«¯ä»‹é¢ */
        #teacherScreen { display: none; padding: 20px; text-align: center; height: 100vh; overflow-y: auto; background: white; }
        #qrcode { margin: 20px auto; display: flex; justify-content: center; }
        .rank-item { background: #eee; padding: 10px; margin: 5px 0; border-radius: 5px; text-align: left; font-size: 18px; }

        /* éŠæˆ²ç•«é¢ */
        #gameScreen { display: none; }
        #questionModal { display: none; position: fixed; top: 10%; left: 5%; width: 90%; background: white; border: 4px solid #FF5722; border-radius: 15px; padding: 20px; box-sizing: border-box; text-align: center; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .opt-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 18px; }
        
        #joystick-zone { position: absolute; bottom: 50px; right: 50px; width: 100px; height: 100px; background: rgba(0,0,0,0.1); border-radius: 50%; display: none; pointer-events: none; }
    </style>
</head>
<body>

    <div id="menuScreen">
        <h1>ğŸ’° æ”¿åºœç†è²¡å¤§ä½œæˆ°</h1>
        <p>å¸¸è­˜ç§‘äº’å‹•éŠæˆ²</p>
        <input type="text" id="playerName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" maxlength="8">
        <button class="btn btn-student" onclick="joinGame()">æˆ‘æ˜¯å­¸ç”Ÿ (é€²å…¥éŠæˆ²)</button>
        <br>
        <button class="btn btn-teacher" onclick="startTeacherMode()">æˆ‘æ˜¯è€å¸« (ä¸»æŒéŠæˆ²)</button>
    </div>

    <div id="teacherScreen">
        <h2>æƒæåŠ å…¥éŠæˆ²</h2>
        <div id="qrcode"></div>
        <h3 id="joinLink"></h3>
        <button class="btn btn-teacher" onclick="resetGame()" style="background: #f44336;">é‡ç½®æ‰€æœ‰ç©å®¶</button>
        <hr>
        <h3>ğŸ† å¯¦æ™‚æ’è¡Œæ¦œ</h3>
        <div id="leaderboard"></div>
    </div>

    <div id="gameScreen">
        <canvas id="canvas"></canvas>
        <div id="questionModal">
            <h2 id="qTitle">é¡Œç›®</h2>
            <div id="qOptions"></div>
        </div>
    </div>

    <script>
        // =================CONFIG å€ (è«‹æ›¿æ›é€™è£¡)=================
const firebaseConfig = {
  apiKey: "AIzaSyCpUjL4C66wWr0mP4Xz_g_FvACvjObaUT0",
  authDomain: "gsmoney-65f2f.firebaseapp.com",
  projectId: "gsmoney-65f2f",
  storageBucket: "gsmoney-65f2f.firebasestorage.app",
  messagingSenderId: "176138167950",
  appId: "1:176138167950:web:48057a0e2cc89612f30bdf",
  measurementId: "G-BKB004KPBN"
};// =======================================================

        if (!firebaseConfig.apiKey) {
            alert("è«‹è¨­å®š Firebase Config (æ‰“é–‹ html æª”æ¡ˆç·¨è¼¯)");
        } else {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.database();
        const playersRef = db.ref('players');
        const gameRef = db.ref('gameState');

        // é¡Œç›®åº«
        const questions = [
            { q: "æ”¿åºœç†è²¡çš„é¦–è¦åŸå‰‡æ˜¯ä»€éº¼ï¼Ÿ", opts: ["é‡å…¥ç‚ºå‡º", "å…ˆä½¿æœªä¾†éŒ¢", "éš¨æ„æ¶ˆè²»"], ans: 0 },
            { q: "æ‰“å·¥ä»”æ¯æœˆæœ‰è–ªé‡‘ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["åˆ©å¾—ç¨…", "è–ªä¿¸ç¨…", "å°èŠ±ç¨…"], ans: 1 },
            { q: "å…¬å¸è³ºå–åˆ©æ½¤å¾Œï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["è–ªä¿¸ç¨…", "å°èŠ±ç¨…", "åˆ©å¾—ç¨…"], ans: 2 },
            { q: "è²·è³£æ¨“å®‡ä½å®…æ™‚ï¼Œè¦äº¤ä»€éº¼ç¨…ï¼Ÿ", opts: ["å°èŠ±ç¨…", "åœ°åƒ¹ç¨…", "å¢å€¼ç¨…"], ans: 0 },
            { q: "æ”¿åºœæ”¶å…¥æ¯”é–‹æ”¯å¤šï¼Œç¨±ç‚ºï¼Ÿ", opts: ["èµ¤å­—", "ç›ˆé¤˜", "ç ´ç”¢"], ans: 1 },
            { q: "ã€Œç›ˆé¤˜ã€æœƒæ’¥å…¥å“ªè£¡ï¼Ÿ", opts: ["è²¡æ”¿å„²å‚™", "éŠ€è¡Œ", "å®˜å“¡å£è¢‹"], ans: 0 },
            { q: "ä»¥ä¸‹å“ªé …ä¸æ˜¯é¦™æ¸¯ä¸»è¦é–‹æ”¯ï¼Ÿ", opts: ["æ•™è‚²", "è»è²»", "é†«ç™‚"], ans: 1 },
            { q: "èˆˆå»ºå¤§æ©‹å±¬æ–¼å“ªé¡é–‹æ”¯ï¼Ÿ", opts: ["ç¤¾æœƒç¦åˆ©", "åŸºç¤å»ºè¨­", "ä¿å®‰"], ans: 1 },
            { q: "äº«ç”¨è¨­æ–½æ˜¯æ¬Šåˆ©ï¼Œç¹³ç¨…æ˜¯ï¼Ÿ", opts: ["èˆˆè¶£", "é¸æ“‡", "ç¾©å‹™"], ans: 2 },
            { q: "é•·æœŸã€Œå…¥ä¸æ•·å‡ºã€æœƒå°è‡´ï¼Ÿ", opts: ["è²¡æ”¿èµ¤å­—", "ç¶“æ¿Ÿç¹æ¦®", "ç¨…æ”¶æ¸›å°‘"], ans: 0 }
        ];

        // è®Šæ•¸
        let myId = null;
        let me = { x: 0, y: 0, r: 20, color: '' };
        let allPlayers = {};
        const WORLD_SIZE = 2000;
        let canvas, ctx;
        let isTeacher = false;

        // ================= è€å¸«é‚è¼¯ (Host) =================
        function startTeacherMode() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('teacherScreen').style.display = 'block';
            isTeacher = true;

            // ç”Ÿæˆ QR Code
            const url = window.location.href;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
            document.getElementById("joinLink").innerText = "ç¶²å€: " + window.location.host;

            // ç›£è½ç©å®¶ä¸¦æ›´æ–°æ’è¡Œæ¦œ
            playersRef.on('value', snap => {
                const list = document.getElementById('leaderboard');
                list.innerHTML = "";
                const data = snap.val() || {};
                
                // è½‰ç‚ºé™£åˆ—ä¸¦æ’åº
                const sorted = Object.values(data).sort((a, b) => b.r - a.r);
                
                sorted.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'rank-item';
                    div.innerHTML = `ç¬¬ ${i+1} å: <strong>${p.name}</strong> (åˆ†æ•¸: ${Math.floor(p.r)})`;
                    list.appendChild(div);
                });
            });

            // å•Ÿå‹•å‡ºé¡Œè¨ˆæ™‚å™¨ (æ¯15ç§’å‡ºä¸€æ¬¡é¡Œ)
            setInterval(() => {
                const qIdx = Math.floor(Math.random() * questions.length);
                const qId = Date.now(); // å”¯ä¸€IDç¢ºä¿é¡Œç›®æ›´æ–°
                gameRef.set({
                    questionId: qId,
                    index: qIdx,
                    timestamp: Date.now()
                });
            }, 15000);
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦è¸¢é™¤æ‰€æœ‰ç©å®¶ä¸¦é‡ç½®å—ï¼Ÿ")) {
                playersRef.remove();
            }
        }

        // ================= å­¸ç”Ÿé‚è¼¯ (Client) =================
        function joinGame() {
            const name = document.getElementById('playerName').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // åˆå§‹åŒ–ç©å®¶
            myId = playersRef.push().key;
            me.x = Math.random() * WORLD_SIZE;
            me.y = Math.random() * WORLD_SIZE;
            me.color = `hsl(${Math.random() * 360}, 80%, 60%)`;
            me.name = name;
            
            updateMyData();

            // ç›£è½æ‰€æœ‰ç©å®¶ç§»å‹•
            playersRef.on('value', snap => {
                allPlayers = snap.val() || {};
                checkCollisions(); // æª¢æŸ¥æ˜¯å¦è¢«åƒæˆ–åƒäºº
            });

            // ç›£è½é¡Œç›®
            gameRef.on('value', snap => {
                const data = snap.val();
                if(data && Date.now() - data.timestamp < 5000) { // 5ç§’å…§çš„é¡Œç›®æ‰é¡¯ç¤º
                    showQuestion(data.index);
                }
            });

            // å•Ÿå‹•ç¹ªåœ–è¿´åœˆ
            requestAnimationFrame(gameLoop);
            
            // å•Ÿå‹•ä½ç½®ä¸Šå‚³è¿´åœˆ (æ¯100msä¸€æ¬¡ï¼Œæ¸›è¼•Firebaseè² æ“”)
            setInterval(updateMyData, 100);
        }

        function updateMyData() {
            if(!myId) return;
            playersRef.child(myId).set({
                name: me.name,
                x: me.x,
                y: me.y,
                r: me.r,
                color: me.color
            });
        }

        // ç§»å‹•æ§åˆ¶
        let mouseX = window.innerWidth / 2;
        let mouseY = window.innerHeight / 2;

        window.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        
        window.addEventListener('touchmove', e => {
            e.preventDefault();
            mouseX = e.touches[0].clientX;
            mouseY = e.touches[0].clientY;
        }, {passive: false});

        function gameLoop() {
            // ç§»å‹•é‚è¼¯
            const dx = mouseX - window.innerWidth / 2;
            const dy = mouseY - window.innerHeight / 2;
            const angle = Math.atan2(dy, dx);
            const speed = 50 / me.r + 2; // è¶Šå¤§è¶Šæ…¢

            me.x += Math.cos(angle) * speed;
            me.y += Math.sin(angle) * speed;

            // é‚Šç•Œé™åˆ¶
            me.x = Math.max(0, Math.min(WORLD_SIZE, me.x));
            me.y = Math.max(0, Math.min(WORLD_SIZE, me.y));

            // ç¹ªåœ–
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ”å½±æ©Ÿè·Ÿéš¨
            ctx.save();
            ctx.translate(canvas.width/2 - me.x, canvas.height/2 - me.y);

            // ç•«é‚Šç•Œ
            ctx.strokeStyle = "#ccc";
            ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);

            // ç•«ç©å®¶
            for (let id in allPlayers) {
                const p = allPlayers[id];
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                // ç•«åå­—
                ctx.fillStyle = "#000";
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText(p.name, p.x, p.y - p.r - 5);
            }
            ctx.restore();
        }

        // ç¢°æ’èˆ‡åƒäººé‚è¼¯ (Clientç«¯ç°¡æ˜“åˆ¤å®š)
        function checkCollisions() {
            for (let id in allPlayers) {
                if (id === myId) continue;
                const p = allPlayers[id];
                const dist = Math.hypot(me.x - p.x, me.y - p.y);

                // æˆ‘åƒåˆ¥äºº (æˆ‘æ¯”ä½ å¤§ 20% ä¸”æ¥è§¸)
                if (dist < me.r && me.r > p.r * 1.2) {
                    // å¢åŠ æˆ‘çš„å¤§å°
                    me.r += p.r * 0.2; 
                    // æ®˜å¿åœ°ç§»é™¤å°æ–¹ (Firebase)
                    playersRef.child(id).remove();
                }
            }

            // æˆ‘è¢«åˆªé™¤ (è¢«åƒæ‰)
            if (!allPlayers[myId]) {
                // é‡ç”Ÿ
                me.x = Math.random() * WORLD_SIZE;
                me.y = Math.random() * WORLD_SIZE;
                me.r = 20;
                updateMyData(); // ç«‹å³å¯«å›è³‡æ–™åº«ä»¥å…é–ƒçˆ
            }
        }

        // é¡Œç›®é¡¯ç¤ºèˆ‡å›ç­”
        function showQuestion(index) {
            const q = questions[index];
            const modal = document.getElementById('questionModal');
            const content = document.getElementById('qOptions');
            
            document.getElementById('qTitle').innerText = q.q;
            content.innerHTML = "";
            modal.style.display = 'block';

            q.opts.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    modal.style.display = 'none';
                    if (i === q.ans) {
                        me.r += 10; // ç­”å°è®Šå¤§
                        updateMyData();
                        alert("ç­”å°äº†ï¼é«”ç©è®Šå¤§ï¼");
                    } else {
                        alert("ç­”éŒ¯äº†...");
                    }
                };
                content.appendChild(btn);
            });
        }
    </script>
</body>
</html>