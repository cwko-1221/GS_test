<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課堂互動點擊器</title>
    
    <!-- 1. 載入 React 和 Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #0f172a; color: white; user-select: none; }
        .animate-pop { animation: pop 0.1s ease-in-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ==========================================
        // ▼ 請在這裡貼上你的 FIREBASE 設定 ▼
        // ==========================================
        
        const firebaseConfig = {
  	apiKey: "AIzaSyDTLZ3mk7RT3iIdF6HVOMMJd91whxbp0HU",
  	authDomain: "test-c3523.firebaseapp.com",
 	 projectId: "test-c3523",
  	storageBucket: "test-c3523.firebasestorage.app",
 	 messagingSenderId: "307093591112",
  	appId: "1:307093591112:web:76559c4dde0b06c203347d",
  	measurementId: "G-9Y028C5CKY"
	};

        // ==========================================
        // ▲ 設定結束 ▲
        // ==========================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 圖示組件
        const Icons = {
            Zap: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            User: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            QrCode: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
            Trash: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        };

        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('landing'); // landing, teacher, student
            const [roomId, setRoomId] = React.useState('');
            const [studentName, setStudentName] = React.useState('');
            const [players, setPlayers] = React.useState([]);
            const [myPlayer, setMyPlayer] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            // 1. 初始化與登入
            React.useEffect(() => {
                const init = async () => {
                    await signInAnonymously(auth);
                    
                    // 檢查 URL 是否帶有房間號 (學生掃描 QR Code 進來的狀況)
                    const params = new URLSearchParams(window.location.search);
                    const urlRoom = params.get('room');
                    
                    if (urlRoom) {
                        setRoomId(urlRoom);
                        setRole('student_setup'); // 進入學生設定名字畫面
                    } else {
                        setRole('landing'); // 進入首頁選擇身分
                    }
                    setLoading(false);
                };
                init();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // 2. 監聽房間數據 (當有 RoomID 時)
            React.useEffect(() => {
                if (!roomId || !user) return;

                const playersRef = collection(db, 'classrooms', roomId, 'players');
                const unsubscribe = onSnapshot(playersRef, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ ...doc.data(), id: doc.id }));
                    list.sort((a, b) => (b.score || 0) - (a.score || 0));
                    setPlayers(list);
                    
                    if (role.startsWith('student')) {
                        const me = list.find(p => p.id === user.uid);
                        if (me) setMyPlayer(me);
                    }
                });

                return () => unsubscribe();
            }, [roomId, user, role]);

            // --- 動作處理 ---

            // 老師建立房間
            const createRoom = () => {
                const newRoomId = Math.floor(1000 + Math.random() * 9000).toString(); // 產生 4 位數房間號
                setRoomId(newRoomId);
                setRole('teacher');
            };

            // 學生加入 (手動輸入房間號)
            const joinRoom = (inputRoomId) => {
                if (!inputRoomId) return alert("請輸入房間號碼");
                setRoomId(inputRoomId);
                setRole('student_setup');
            };

            // 學生設定名字並開始
            const startStudentGame = async () => {
                if (!studentName.trim()) return alert("請輸入你的名字");
                if (!user || !roomId) return;

                const playerRef = doc(db, 'classrooms', roomId, 'players', user.uid);
                await setDoc(playerRef, {
                    id: user.uid,
                    name: studentName,
                    score: 0,
                    joinedAt: serverTimestamp()
                }, { merge: true });

                setRole('student_play');
            };

            // 學生點擊得分
            const handleClick = async () => {
                if (!user || !roomId) return;
                // 簡單動畫
                const btn = document.getElementById('click-btn');
                if(btn) {
                    btn.classList.remove('animate-pop');
                    void btn.offsetWidth; // trigger reflow
                    btn.classList.add('animate-pop');
                }

                const playerRef = doc(db, 'classrooms', roomId, 'players', user.uid);
                await updateDoc(playerRef, { score: increment(1) });
            };

            // 老師重置分數
            const resetScores = async () => {
                if (!confirm("確定要將所有學生的分數歸零嗎？")) return;
                const batchPromises = players.map(p => {
                    const ref = doc(db, 'classrooms', roomId, 'players', p.id);
                    return updateDoc(ref, { score: 0 });
                });
                await Promise.all(batchPromises);
            };

            // --- 渲染畫面 ---

            if (loading) return <div className="flex h-screen justify-center items-center text-blue-400">載入中...</div>;

            // 0. 首頁 (選擇身分)
            if (role === 'landing') {
                return (
                    <div className="flex flex-col h-screen justify-center items-center p-6 gap-6 max-w-md mx-auto">
                        <h1 className="text-3xl font-bold text-yellow-400 flex items-center gap-2">
                            <Icons.Zap className="fill-current"/> 課堂互動點擊器
                        </h1>
                        <div className="w-full grid gap-4">
                            <button onClick={createRoom} className="bg-blue-600 hover:bg-blue-500 p-6 rounded-xl text-xl font-bold transition flex items-center justify-center gap-3">
                                <Icons.QrCode /> 我是老師 (建立房間)
                            </button>
                            <div className="relative border-t border-slate-700 my-2">
                                <span className="absolute top-[-12px] left-1/2 -translate-x-1/2 bg-[#0f172a] px-2 text-slate-500 text-sm">或是</span>
                            </div>
                            <div className="bg-slate-800 p-6 rounded-xl flex flex-col gap-3 border border-slate-700">
                                <label className="text-slate-400 text-sm">輸入房間號碼加入：</label>
                                <div className="flex gap-2">
                                    <input type="number" id="roomInput" placeholder="例如: 1234" className="bg-slate-900 border border-slate-600 rounded-lg p-3 w-full text-center text-lg focus:border-blue-500 outline-none" />
                                    <button onClick={() => joinRoom(document.getElementById('roomInput').value)} className="bg-green-600 hover:bg-green-500 px-6 rounded-lg font-bold">加入</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 1. 老師介面 (顯示 QR Code 與排行榜)
            if (role === 'teacher') {
                const joinUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?room=${roomId}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(joinUrl)}`;

                return (
                    <div className="min-h-screen flex flex-col md:flex-row bg-slate-900">
                        {/* 左側：控制面板 */}
                        <div className="md:w-1/3 bg-slate-800 p-6 border-r border-slate-700 flex flex-col items-center justify-center text-center gap-6 sticky top-0">
                            <div>
                                <h2 className="text-slate-400 mb-1">房間號碼</h2>
                                <div className="text-6xl font-black text-yellow-400 tracking-widest">{roomId}</div>
                            </div>
                            
                            <div className="bg-white p-2 rounded-lg">
                                <img src={qrUrl} alt="Room QR Code" className="w-48 h-48" />
                            </div>
                            <p className="text-slate-300 text-sm">請學生掃描 QR Code 或輸入房間號碼</p>
                            
                            <div className="mt-4 flex gap-2 w-full">
                                <button onClick={resetScores} className="flex-1 bg-red-900/50 text-red-400 border border-red-800 p-2 rounded hover:bg-red-900 transition flex justify-center items-center gap-2">
                                    <Icons.Trash size={16}/> 重置分數
                                </button>
                            </div>
                        </div>

                        {/* 右側：即時排行榜 */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold flex items-center gap-2">
                                    <Icons.Zap className="text-yellow-400 fill-yellow-400"/> 即時戰況
                                </h2>
                                <span className="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm">
                                    {players.length} 位學生
                                </span>
                            </div>

                            <div className="grid grid-cols-1 gap-3">
                                {players.length === 0 ? (
                                    <div className="text-center text-slate-500 py-20">等待學生加入中...</div>
                                ) : (
                                    players.map((p, i) => (
                                        <div key={p.id} className={`flex items-center justify-between p-4 rounded-xl border transition-all ${i===0 ? 'bg-yellow-900/20 border-yellow-500/50 scale-[1.02]' : 'bg-slate-800 border-slate-700'}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${i===0 ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/50' : i===1 ? 'bg-gray-300 text-black' : i===2 ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                                    {i + 1}
                                                </div>
                                                <span className={`text-xl font-bold ${i===0 ? 'text-yellow-400' : 'text-white'}`}>{p.name}</span>
                                            </div>
                                            <span className="text-3xl font-mono font-black">{p.score}</span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // 2. 學生介面 - 輸入名字
            if (role === 'student_setup') {
                return (
                    <div className="h-screen flex flex-col justify-center items-center p-6 bg-slate-900 max-w-md mx-auto">
                        <div className="w-full bg-slate-800 p-8 rounded-2xl border border-slate-700 text-center">
                            <h2 className="text-xl font-bold mb-6 text-blue-400">加入房間 {roomId}</h2>
                            <label className="block text-left text-slate-400 mb-2 text-sm">你的名字 (或暱稱)</label>
                            <input 
                                type="text" 
                                value={studentName}
                                onChange={(e) => setStudentName(e.target.value)}
                                placeholder="例如: 王小明" 
                                className="w-full bg-slate-900 border border-slate-600 rounded-lg p-4 text-lg text-white mb-6 focus:border-blue-500 outline-none"
                            />
                            <button onClick={startStudentGame} className="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold text-lg text-white transition">
                                開始戰鬥！
                            </button>
                        </div>
                    </div>
                );
            }

            // 3. 學生介面 - 遊戲中
            if (role === 'student_play') {
                return (
                    <div className="min-h-screen flex flex-col items-center bg-slate-900 max-w-md mx-auto relative overflow-hidden">
                        <header className="w-full p-4 flex justify-between items-center bg-slate-800/50 border-b border-slate-700">
                            <span className="font-bold text-slate-400">Room: {roomId}</span>
                            <div className="flex items-center gap-2">
                                <Icons.User className="w-4 h-4 text-blue-400"/>
                                <span className="font-bold">{studentName}</span>
                            </div>
                        </header>

                        <div className="flex-1 flex flex-col items-center justify-center w-full gap-8">
                            <div className="text-center">
                                <div className="text-slate-400 mb-1">你的目前分數</div>
                                <div className="text-6xl font-black font-mono text-white tracking-tighter">
                                    {myPlayer?.score || 0}
                                </div>
                            </div>

                            <button 
                                id="click-btn"
                                onMouseDown={handleClick}
                                onTouchStart={(e) => { e.preventDefault(); handleClick(); }}
                                className="w-56 h-56 rounded-full bg-gradient-to-b from-blue-500 to-blue-700 shadow-[0_10px_40px_rgba(59,130,246,0.4)] border-4 border-blue-400 flex flex-col items-center justify-center active:scale-95 transition-transform touch-manipulation cursor-pointer select-none -webkit-tap-highlight-color-transparent"
                            >
                                <Icons.Zap className="w-20 h-20 text-white fill-white mb-2" />
                                <span className="text-2xl font-black text-white uppercase tracking-widest">TAP!</span>
                            </button>
                            
                            <p className="text-slate-500 text-sm animate-pulse">瘋狂點擊來增加分數！</p>
                        </div>
                        
                        {/* 顯示目前第一名 */}
                        {players.length > 0 && (
                            <div className="w-full bg-slate-800 p-3 text-center border-t border-slate-700">
                                <span className="text-slate-400 text-xs">目前冠軍</span>
                                <div className="text-yellow-400 font-bold flex items-center justify-center gap-2">
                                    {players[0].name} 
                                    <span className="text-white font-mono">({players[0].score})</span>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>